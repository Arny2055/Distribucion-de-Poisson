<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS Pro - Análisis de ROI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bet-green: #10b981; 
            --bet-yellow: #fbbf24; 
            --deep-black: #020617; /* Slate 950 para un fondo casi total */
            --card-bg: #0f172a;    /* Slate 900 para tarjetas */
            --border-color: rgba(255, 255, 255, 0.05);
        }
        
        body { 
            background-color: var(--deep-black); 
            color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at top right, #064e3b20, transparent);
        }

        .glass-card { 
            background: rgba(15, 23, 42, 0.95); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        
        .excel-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .excel-table th { 
            background: #1e293b; 
            color: #10b981; 
            text-transform: uppercase; 
            padding: 12px 10px; 
            text-align: left; 
            border-bottom: 2px solid rgba(16, 185, 129, 0.3); 
        }
        .excel-table td { padding: 12px 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.02); vertical-align: middle; }
        
        /* Ajuste de opacidad en estados para que se sientan "profundos" */
        .row-win { background: rgba(16, 185, 129, 0.08) !important; border-left: 4px solid #10b981; }
        .row-win td { color: #4ade80 !important; font-weight: 500; }
        
        .row-loss { background: rgba(239, 68, 68, 0.08) !important; border-left: 4px solid #ef4444; }
        .row-loss td { color: #f87171 !important; font-weight: 500; }
        
        .row-pending { background: rgba(251, 191, 36, 0.1) !important; border-left: 4px solid var(--bet-yellow); }
        .row-pending td { color: var(--bet-yellow) !important; font-weight: 500; }
        
        .btn-action { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 9px; transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .btn-win { background: #059669; color: white; }
        .btn-loss { background: #dc2626; color: white; }
        .btn-pending { background: #d97706; color: white; }
        
        .scroll-custom::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .scroll-custom::-webkit-scrollbar-thumb:hover { background: #10b981; }

        #filter-container { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-height: 0; overflow: hidden; opacity: 0; }
        #filter-container.show { max-height: 1000px; opacity: 1; margin-top: 1rem; padding-bottom: 1rem; }
        
        .filter-mini { background: #020617; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 4px 6px; color: #10b981; font-size: 10px; width: 48%; outline: none; }
        .filter-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .filter-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; font-weight: 600; width: 60px; }
        
        .dot-active { height: 8px; width: 8px; background-color: var(--bet-yellow); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--bet-yellow); }
        .rotate-icon { transition: transform 0.3s ease; }
        .rotate-icon.active { transform: rotate(180deg); }

        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body>
    <nav class="p-4 bg-black/60 border-b border-emerald-500/10 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tighter">BETAGS <span class="text-emerald-500">ROI LAB</span></h1>
            <div class="flex gap-2">
                <a href="index.html" class="px-4 py-1.5 text-xs font-semibold bg-slate-900 rounded-full border border-slate-800 hover:border-emerald-500/50 transition">Calculadora</a>
                <a href="roi.html" class="px-4 py-1.5 text-xs font-semibold bg-emerald-500/10 text-emerald-400 rounded-full border border-emerald-500/30">ROI History</a>
                <a href="backtesting.html" class="px-4 py-1.5 text-xs font-semibold bg-slate-900 rounded-full border border-slate-800 hover:border-emerald-500/50 transition">Backtesting</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-8">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Profit Total</p>
                <p id="stat-profit" class="text-xl font-black text-white">$0.00</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Yield</p>
                <p id="stat-yield" class="text-xl font-black text-emerald-400">0%</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Hit Rate</p>
                <p id="stat-hit" class="text-xl font-black text-blue-400">0%</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-red-500/80 uppercase font-bold tracking-widest mb-1">Max Drawdown</p>
                <p id="stat-dd" class="text-xl font-black text-red-500">0.00u</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Total Picks</p>
                <p id="stat-count" class="text-xl font-black text-white">0</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center border-emerald-500/30">
                <p class="text-[10px] text-emerald-500 uppercase font-bold tracking-widest mb-1">P-Value</p>
                <p id="stat-pvalue" class="text-xl font-black text-emerald-400">--</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-card p-5 rounded-2xl">
                    <button onclick="toggleFilters()" class="w-full flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-black uppercase text-emerald-500 tracking-tighter">Panel de Filtros</span>
                            <div id="active-indicator" class="hidden"><span class="dot-active"></span></div>
                        </div>
                        <i id="filter-chevron" class="fa-solid fa-chevron-down text-slate-500 group-hover:text-emerald-500 rotate-icon"></i>
                    </button>

                    <div id="filter-container">
                        <div class="space-y-4 pt-6">
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Mercado</label>
                                <select id="f_market" class="w-full bg-slate-950 p-2.5 text-[11px] rounded-lg border border-slate-800 text-slate-200" onchange="updateStats()">
                                    <option value="">Todos los Mercados</option>
                                    <option value="OVER 2.5 GOLES">Over 2.5 Goles</option>
                                    <option value="UNDER 2.5 GOLES">Under 2.5 Goles</option>
                                    <option value="BTTS (SÍ)">BTTS (Sí)</option>
                                    <option value="BTTS (NO)">BTTS (No)</option>
                                    <option value="MARCADOR">Marcador</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Algoritmo</label>
                                <select id="f_source" class="w-full bg-slate-950 p-2.5 text-[11px] rounded-lg border border-slate-800 text-slate-200" onchange="updateStats()">
                                    <option value="">Cualquier Origen</option>
                                    <option value="XG">Basado en xG</option>
                                    <option value="GOLES">Basado en Goles</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Estado</label>
                                <select id="f_status" class="w-full bg-slate-950 p-2.5 text-[11px] rounded-lg border border-slate-800 text-slate-200" onchange="updateStats()">
                                    <option value="">Cualquier Resultado</option>
                                    <option value="win">W - Ganadas</option>
                                    <option value="loss">L - Perdidas</option>
                                    <option value="pending">P - Pendientes</option>
                                </select>
                            </div>

                            <div class="pt-4 border-t border-slate-800 space-y-3">
                                <p class="text-[10px] text-emerald-500 font-black uppercase">Rangos de Valor</p>
                                <div class="filter-row">
                                    <span class="filter-label">Prob %</span>
                                    <input type="number" id="f_p_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_p_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">C. Justa</span>
                                    <input type="number" id="f_fj_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_fj_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">C. Casa</span>
                                    <input type="number" id="f_oc_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_oc_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">Edge %</span>
                                    <input type="number" id="f_e_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_e_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">Stake</span>
                                    <input type="number" id="f_s_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_s_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                            </div>

                            <button onclick="resetFilters()" class="w-full text-[9px] text-slate-500 hover:text-white underline py-2 transition-colors">Limpiar filtros aplicados</button>

                            <div class="pt-4 border-t border-slate-800 space-y-2">
                                <button onclick="sendToBacktesting()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black rounded-lg uppercase shadow-lg shadow-blue-900/20 transition-all">
                                    <i class="fa-solid fa-vial-circle-check mr-2"></i>Enviar a Backtesting
                                </button>
                                <button onclick="exportToExcel()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black rounded-lg uppercase shadow-lg shadow-emerald-900/20 transition-all">
                                    <i class="fa-solid fa-file-excel mr-2"></i>Exportar CSV
                                </button>
                                <button onclick="clearHistory()" class="w-full py-2 bg-transparent text-red-500 hover:bg-red-500/10 text-[10px] font-bold rounded-lg uppercase transition-all">Borrar Historial</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5 rounded-2xl">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-4 text-center tracking-widest">Equity Curve (u)</p>
                    <div class="h-[150px]">
                        <canvas id="bankrollChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="glass-card rounded-2xl overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto scroll-custom">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>Evento / Fecha</th>
                                    <th>Mercado</th>
                                    <th>Prob %</th>
                                    <th>Justa</th>
                                    <th>Casa</th>
                                    <th>Edge</th>
                                    <th>Stake</th>
                                    <th>Resolución</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'betags_v3_miner';
        let bets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let bChart;

        function toggleFilters() {
            const container = document.getElementById('filter-container');
            const icon = document.getElementById('filter-chevron');
            container.classList.toggle('show');
            icon.classList.toggle('active');
        }

        function resetFilters() {
            const inputs = document.querySelectorAll('.filter-mini, select');
            inputs.forEach(i => i.value = '');
            updateStats();
        }

        function calculatePValue(n, yieldVal, avgOdd) {
            if (n < 5 || avgOdd <= 1) return null;
            try {
                const yieldDec = yieldVal / 100;
                const sd = Math.sqrt(avgOdd - 1) / Math.sqrt(n);
                if (sd === 0) return null;
                const z = yieldDec / sd;
                const t = 1 / (1 + 0.5 * Math.abs(z));
                const ans = 1 - t * Math.exp(-z * z - 1.26551223 + t * (1.00002368 + t * (0.37409196 + t * (0.09678418 + t * (-0.18628806 + t * (0.27886807 + t * (-1.13520398 + t * (1.48851587 + t * (-0.82215223 + t * 0.17087277)))))))));
                return z >= 0 ? 1 - (ans + 1) / 2 : (ans + 1) / 2;
            } catch (e) { return null; }
        }

        function updateStats() {
            const f_market = document.getElementById('f_market').value;
            const f_status = document.getElementById('f_status').value;
            const f_source = document.getElementById('f_source').value;
            
            const pMin = parseFloat(document.getElementById('f_p_min').value) || -Infinity;
            const pMax = parseFloat(document.getElementById('f_p_max').value) || Infinity;
            const fjMin = parseFloat(document.getElementById('f_fj_min').value) || -Infinity;
            const fjMax = parseFloat(document.getElementById('f_fj_max').value) || Infinity;
            const ocMin = parseFloat(document.getElementById('f_oc_min').value) || -Infinity;
            const ocMax = parseFloat(document.getElementById('f_oc_max').value) || Infinity;
            const eMin = parseFloat(document.getElementById('f_e_min').value) || -Infinity;
            const eMax = parseFloat(document.getElementById('f_e_max').value) || Infinity;
            const sMin = parseFloat(document.getElementById('f_s_min').value) || -Infinity;
            const sMax = parseFloat(document.getElementById('f_s_max').value) || Infinity;

            const isFiltering = f_market || f_status || f_source || pMin !== -Infinity || pMax !== Infinity || fjMin !== -Infinity || fjMax !== Infinity || ocMin !== -Infinity || ocMax !== Infinity || eMin !== -Infinity || eMax !== Infinity || sMin !== -Infinity || sMax !== Infinity;
            document.getElementById('active-indicator').style.display = isFiltering ? 'inline-block' : 'none';

            const filtered = bets.filter(b => {
                const matchM = !f_market || (b.market && b.market.toString().toUpperCase().includes(f_market.toUpperCase()));
                const matchS = !f_status || (b.status === f_status);
                const matchSource = !f_source || (b.teams && b.teams.toUpperCase().includes(f_source.toUpperCase()));
                
                const prob = (Number(b.prob) * 100) || 0;
                const fair = Number(b.fair_odd) || (b.prob ? 1/b.prob : 0);
                const odd = Number(b.odd) || 0;
                const edge = parseFloat(b.edge?.toString().replace('%','')) || 0;
                const stake = Number(b.stake) || 0;

                return matchM && matchS && matchSource && (prob >= pMin && prob <= pMax) && (fair >= fjMin && fair <= fjMax) && (odd >= ocMin && odd <= ocMax) && (edge >= eMin && edge <= eMax) && (stake >= sMin && stake <= sMax);
            });

            const resolved = filtered.filter(b => b.status === 'win' || b.status === 'loss');
            const sortedResolved = [...resolved].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            const profit = sortedResolved.reduce((a, b) => a + (Number(b.profit) || 0), 0);
            const staked = sortedResolved.reduce((a, b) => a + (Number(b.stake) || 0), 0);
            
            let currentBank = 100;
            let peak = 100;
            let maxDD = 0;
            sortedResolved.forEach(b => {
                currentBank += Number(b.profit);
                if(currentBank > peak) peak = currentBank;
                let dd = peak - currentBank;
                if(dd > maxDD) maxDD = dd;
            });

            const wins = sortedResolved.filter(b => b.status === 'win').length;
            const avgOdd = sortedResolved.length > 0 ? sortedResolved.reduce((a, b) => a + (Number(b.odd) || 0), 0) / sortedResolved.length : 0;
            const currentYield = staked > 0 ? (profit/staked*100) : 0;
            
            document.getElementById('stat-profit').innerText = (profit >= 0 ? "+" : "") + profit.toFixed(2) + "u";
            document.getElementById('stat-profit').className = profit >= 0 ? "text-xl font-black text-emerald-400" : "text-xl font-black text-red-400";
            document.getElementById('stat-yield').innerText = currentYield.toFixed(1) + "%";
            document.getElementById('stat-hit').innerText = (sortedResolved.length > 0 ? (wins/sortedResolved.length*100).toFixed(1) : 0) + "%";
            document.getElementById('stat-dd').innerText = maxDD.toFixed(2) + "u";
            document.getElementById('stat-count').innerText = sortedResolved.length;

            const pVal = calculatePValue(sortedResolved.length, currentYield, avgOdd);
            const pElem = document.getElementById('stat-pvalue');
            if(pVal !== null) {
                pElem.innerText = (pVal * 100).toFixed(2) + "%";
                pElem.className = pVal < 0.05 ? "text-xl font-black text-emerald-400" : "text-xl font-black text-yellow-500";
            } else { pElem.innerText = "--"; }
            
            renderHistory(filtered);
            renderBankrollChart(sortedResolved);
        }

        function renderHistory(data) {
            const tbody = document.getElementById('history-body'); 
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-10 text-center text-slate-600 font-bold italic">No se encontraron registros con los filtros actuales</td></tr>';
                return;
            }

            const displayData = [...data].sort((a, b) => (new Date(b.date) - new Date(a.date)) || (b.id - a.id));
            
            displayData.forEach(b => {
                const tr = document.createElement('tr');
                const status = b.status || 'pending';
                tr.className = `row-${status}`;
                
                const probDisp = b.prob ? (Number(b.prob) * 100).toFixed(1) + "%" : "0%";
                const fairDisp = b.fair_odd ? Number(b.fair_odd).toFixed(2) : (b.prob ? (1/Number(b.prob)).toFixed(2) : "0.00");
                const edgeVal = parseFloat(b.edge?.toString().replace('%','')) || 0;

                tr.innerHTML = `
                    <td>
                        <div class="font-bold text-slate-100">${b.teams || 'Evento'}</div>
                        <div class="text-[9px] text-slate-500 font-mono tracking-tighter uppercase">${b.date || ''}</div>
                    </td>
                    <td class="font-bold text-emerald-500">${b.market || '-'}</td>
                    <td class="text-slate-400">${probDisp}</td>
                    <td class="text-slate-400">${fairDisp}</td>
                    <td class="font-black text-white">${b.odd || '0.00'}</td>
                    <td class="${edgeVal > 0 ? 'text-emerald-400 font-bold' : 'text-slate-500'}">${edgeVal.toFixed(1)}%</td>
                    <td class="font-bold">${b.stake || '0'}u</td>
                    <td>
                        <div class="flex gap-1">
                            <button onclick="resolve('${b.id}', 'win')" class="btn-action btn-win">W</button>
                            <button onclick="resolve('${b.id}', 'loss')" class="btn-action btn-loss">L</button>
                            <button onclick="resolve('${b.id}', 'pending')" class="btn-action btn-pending">P</button>
                        </div>
                    </td>
                    <td>
                        <button onclick="deleteBet('${b.id}')" class="text-slate-700 hover:text-red-500 transition-colors px-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function resolve(id, status) {
            const idx = bets.findIndex(x => x.id.toString() === id.toString());
            if(idx !== -1) {
                bets[idx].status = status;
                const odd = Number(bets[idx].odd) || 0;
                const stake = Number(bets[idx].stake) || 0;
                bets[idx].profit = status === 'win' ? stake * (odd - 1) : (status === 'loss' ? -stake : 0);
                saveAndRefresh();
            }
        }

        function renderBankrollChart(sortedResolved) {
            const ctx = document.getElementById('bankrollChart').getContext('2d');
            if(bChart) bChart.destroy();
            
            let current = 100;
            let chartData = [100];
            sortedResolved.forEach(b => { current += Number(b.profit); chartData.push(current); });

            bChart = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: chartData.map((_,i)=>i), 
                    datasets: [{ 
                        data: chartData, 
                        borderColor: '#10b981', 
                        borderWidth: 2,
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
                            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                            return gradient;
                        },
                        fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 4
                    }] 
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false } },
                    scales: { 
                        x: { display: false }, 
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, 
                            ticks: { color: '#475569', font: { size: 9, weight: 'bold' } } 
                        } 
                    }
                }
            });
        }

        function deleteBet(id) { if(confirm('¿Eliminar esta entrada permanentemente?')) { bets = bets.filter(x => x.id.toString() !== id.toString()); saveAndRefresh(); } }
        function saveAndRefresh() { localStorage.setItem(STORAGE_KEY, JSON.stringify(bets)); updateStats(); }
        function clearHistory() { if(confirm('¿BORRAR TODO EL HISTORIAL? Esta acción es irreversible.')) { bets = []; saveAndRefresh(); } }
        
        function sendToBacktesting() {
            // Filtramos solo las apuestas ganadas o perdidas
            const resolvedBets = bets.filter(b => b.status === 'win' || b.status === 'loss');
            
            if (resolvedBets.length === 0) {
                alert("No hay apuestas resueltas para enviar. Resuelve algunas apuestas como W o L primero.");
                return;
            }

            // Clave que usa la herramienta de Backtesting
            const BACKTEST_KEY = 'betags_backtesting';
            let existingBacktest = JSON.parse(localStorage.getItem(BACKTEST_KEY)) || [];

            // Evitamos duplicados comparando IDs únicos
            const newBets = resolvedBets.filter(rb => !existingBacktest.some(eb => eb.id === rb.id));

            if (newBets.length === 0) {
                alert("Todas las apuestas resueltas actuales ya se encuentran en el historial de Backtesting.");
                return;
            }

            const updatedBacktest = [...existingBacktest, ...newBets];
            localStorage.setItem(BACKTEST_KEY, JSON.stringify(updatedBacktest));
            
            alert(`¡Éxito! Se han enviado ${newBets.length} apuestas nuevas al módulo de Backtesting.`);
        }

        function exportToExcel() {
            if (bets.length === 0) return;
            const headers = ["FECHA", "EQUIPOS", "MERCADO", "CUOTA", "STAKE", "PROFIT", "RESULTADO"];
            const rows = bets.map(b => [b.date, b.teams, b.market, b.odd, b.stake, b.profit, b.status].join(","));
            const csv = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = `ROI_BetAGS_Export.csv`;
            link.click();
        }

        window.onload = updateStats;
    </script>
</body>
</html>
