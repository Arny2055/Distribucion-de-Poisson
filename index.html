<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Poisson Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff; /* Cyan BETAGS */
            --sl-green: #00ff88;
            --sl-yellow: #f0db4f;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        input, select { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
            transition: all 0.2s ease; 
        }

        input:focus, select:focus {
            border-color: var(--sl-accent) !important;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
            outline: none;
        }

        .market-row { border-bottom: 1px solid var(--sl-border); transition: background 0.3s; }
        .market-row:hover { background: rgba(255,255,255,0.02); }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge-value {
            background: rgba(0, 255, 136, 0.1);
            color: var(--sl-green);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .auto-select {
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--sl-accent);
        }

        .match-counter {
            font-size: 9px;
            letter-spacing: 0.5px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sample-badge {
            font-size: 8px;
            background: #1e293b;
            color: var(--sl-accent);
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(0, 242, 255, 0.2);
        }

        .history-item {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--sl-border);
            border-radius: 6px;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        /* Value Alertas */
        .card-value-high {
            border: 1px solid var(--sl-gold) !important;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
            position: relative;
        }

        .card-value-mid {
            border: 1px solid var(--sl-green) !important;
        }

        .badge-value-hit {
            position: absolute;
            top: -8px;
            right: 10px;
            background: var(--sl-gold);
            color: black;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        /* Estilo para el scanner de automatizaci√≥n */
        .scanner-active {
            border: 1px solid var(--sl-accent);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 242, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); }
        }

        /* Config Panel */
        #config_panel {
            display: none;
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 100;
            width: 300px;
            max-height: 85vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v4.5 PRO</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Scanner Mercado</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over05ht">OVER 0.5 HT</option>
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="under25">UNDER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                        <option value="btts_no">BTTS NO</option>
                    </select>
                </div>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-gear mr-1"></i> IDS
                </button>
                <button onclick="syncAllMarkets()" class="text-[10px] font-black bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 px-3 py-1 rounded hover:bg-cyan-600/40 transition-all">
                    <i class="fa-solid fa-satellite-dish mr-1"></i> RADAR VALUE
                </button>
                <a href="roi.html" class="text-xs font-bold text-slate-400 hover:text-cyan-400 transition-colors"><i class="fa-solid fa-chart-pie mr-1"></i> ROI Panel</a>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3"><i class="fa-solid fa-database mr-1"></i> Configurar IDs de Google Sheets</h3>
        
        <div class="space-y-4">
            <div class="bg-black/20 p-2 rounded border border-white/5">
                <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Base de Datos (Stats)</p>
                <div class="space-y-2">
                    <div>
                        <label class="text-[7px] uppercase text-cyan-500 font-bold">Top Ligas Europeas ID</label>
                        <input type="text" id="id_stats_top" class="w-full p-2 text-[10px] rounded" placeholder="ID Top Europa...">
                    </div>
                    <div>
                        <label class="text-[7px] uppercase text-cyan-500 font-bold">Todas las Ligas ID</label>
                        <input type="text" id="id_stats_all" class="w-full p-2 text-[10px] rounded" placeholder="ID Global...">
                    </div>
                    <div class="flex flex-col gap-1 mt-1">
                        <label class="text-[7px] uppercase text-slate-500 font-bold">Usar Base de Datos:</label>
                        <select id="active_stats_id" class="text-[10px] p-1 rounded">
                            <option value="top">Top Ligas Europeas</option>
                            <option value="all">Todas las Ligas</option>
                        </select>
                    </div>
                </div>
            </div>

            <hr class="border-white/5">

            <div class="space-y-2">
                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Pr√≥ximos Partidos (Scanner)</p>
                <div>
                    <label class="text-[8px] uppercase text-slate-500 font-bold">Over 0.5 HT ID</label>
                    <input type="text" id="id_over05ht" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
                </div>
                <div>
                    <label class="text-[8px] uppercase text-slate-500 font-bold">Over 2.5 FT ID</label>
                    <input type="text" id="id_over25" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
                </div>
                <div>
                    <label class="text-[8px] uppercase text-slate-500 font-bold">Under 2.5 FT ID</label>
                    <input type="text" id="id_under25" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
                </div>
                <div>
                    <label class="text-[8px] uppercase text-slate-500 font-bold">BTTS YES ID</label>
                    <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
                </div>
                <div>
                    <label class="text-[8px] uppercase text-slate-500 font-bold">BTTS NO ID</label>
                    <input type="text" id="id_btts_no" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
                </div>
            </div>
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar Configuraci√≥n</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="scorelab-card p-3 mb-6 overflow-x-auto">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-[10px] font-black text-cyan-500 uppercase tracking-widest"><i class="fa-solid fa-bolt mr-1"></i> Radar de Pr√≥ximos Partidos</span>
                <span id="scan_status" class="text-[9px] text-slate-500 font-mono">Detecci√≥n de Value Activa</span>
            </div>
            <div id="auto_matches_list" class="flex gap-3 pb-4 min-w-max">
                <p class="text-xs text-slate-600 p-4">Sincroniza para detectar oportunidades...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">1. Elegir Liga</span>
                    <span id="league_count" class="match-counter"><i class="fa-solid fa-database text-[8px]"></i> 0 Partidos</span>
                </div>
                <select id="league_select" onchange="filterTeamsByLeague()" class="p-2 rounded text-xs auto-select">
                    <option value="">Cargando ligas...</option>
                </select>
            </div>
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">2. Equipo Local</span>
                    <span id="home_sample" class="sample-badge">N = 0</span>
                </div>
                <select id="home_select" onchange="loadStatsIndependent()" class="p-2 rounded text-xs auto-select">
                    <option value="">Liga primero</option>
                </select>
            </div>
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">3. Equipo Visitante</span>
                    <span id="away_sample" class="sample-badge">N = 0</span>
                </div>
                <select id="away_select" onchange="loadStatsIndependent()" class="p-2 rounded text-xs auto-select">
                    <option value="">Liga primero</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest"><i class="fa-solid fa-database mr-2"></i>Data Entry</h2>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="league_name" placeholder="LIGA" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                            <input type="text" id="event_name" placeholder="EVENTO" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                        </div>

                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-slate-400">Local Casa: GF Favor / GC Contra</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="h_gf" step="0.01" placeholder="GF" class="p-3 rounded-lg text-center">
                                <input type="number" id="h_gc" step="0.01" placeholder="GC" class="p-3 rounded-lg text-center">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-slate-400">Visita Fuera: GF Favor / GC Contra</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="a_gf" step="0.01" placeholder="GF" class="p-3 rounded-lg text-center">
                                <input type="number" id="a_gc" step="0.01" placeholder="GC" class="p-3 rounded-lg text-center">
                            </div>
                        </div>

                        <button onclick="calculate()" class="btn-primary w-full py-4 rounded-xl shadow-lg shadow-cyan-500/20 active:scale-95 transition-transform mt-2">
                            Analizar Probabilidades
                        </button>
                    </div>
                </div>

                <div class="scorelab-card p-5 overflow-hidden">
                    <h2 class="text-[10px] font-black text-slate-500 uppercase mb-3 tracking-widest">Distribuci√≥n de Probabilidad</h2>
                    <div class="h-48">
                        <canvas id="distChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="scorelab-card p-4 border-l-2 border-cyan-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 0.5 HT</p>
                        <h3 id="res_ht05" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ht05" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-green-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 2.5 FT</p>
                        <h3 id="res_ft25" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ft25" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-yellow-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">BTTS (Ambos Anotan)</p>
                        <h3 id="res_btts" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_btts" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                            <tr>
                                <th class="p-4">Mercado Analizado</th>
                                <th class="p-4">Probabilidad</th>
                                <th class="p-4">Cuota Justa</th>
                                <th class="p-4">Cuota Casa</th>
                                <th class="p-4">Œî Prob (%)</th>
                                <th class="p-4 text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="market-body" class="text-sm"></tbody>
                    </table>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="scorelab-card p-5">
                        <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest text-center">Score Matrix (Top 15)</h2>
                        <div id="score-matrix" class="grid grid-cols-5 gap-2"></div>
                    </div>
                    <div class="scorelab-card p-5">
                        <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest text-center">Muestra (Primeros 10 del Sheet)</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-[8px] text-cyan-500 font-bold mb-2 uppercase text-center">Home (Locales)</p>
                                <div id="history-home" class="space-y-1"></div>
                            </div>
                            <div>
                                <p class="text-[8px] text-green-500 font-bold mb-2 uppercase text-center">Away (Visitantes)</p>
                                <div id="history-away" class="space-y-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let chart;
        let database = [];
        let autoMatches = []; 
        const STORAGE_KEY = 'betags_pre_match';
        const IDS_KEY = 'betags_sheet_ids';
        
        let SHEET_IDS = {
            over05ht: '',
            over25: '1BfAXMV6EHLEz3CJ2lAZO6spHJUXQ-mh6',
            under25: '',
            btts_yes: '',
            btts_no: '',
            stats_top: '1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO', // Default anterior
            stats_all: '',
            active_stats: 'top'
        };

        function loadSavedIDs() {
            const saved = localStorage.getItem(IDS_KEY);
            if(saved) {
                SHEET_IDS = JSON.parse(saved);
                document.getElementById('id_over05ht').value = SHEET_IDS.over05ht || '';
                document.getElementById('id_over25').value = SHEET_IDS.over25 || '';
                document.getElementById('id_under25').value = SHEET_IDS.under25 || '';
                document.getElementById('id_btts_yes').value = SHEET_IDS.btts_yes || '';
                document.getElementById('id_btts_no').value = SHEET_IDS.btts_no || '';
                document.getElementById('id_stats_top').value = SHEET_IDS.stats_top || '';
                document.getElementById('id_stats_all').value = SHEET_IDS.stats_all || '';
                document.getElementById('active_stats_id').value = SHEET_IDS.active_stats || 'top';
            }
        }

        function saveIDs() {
            SHEET_IDS.over05ht = document.getElementById('id_over05ht').value.trim();
            SHEET_IDS.over25 = document.getElementById('id_over25').value.trim();
            SHEET_IDS.under25 = document.getElementById('id_under25').value.trim();
            SHEET_IDS.btts_yes = document.getElementById('id_btts_yes').value.trim();
            SHEET_IDS.btts_no = document.getElementById('id_btts_no').value.trim();
            SHEET_IDS.stats_top = document.getElementById('id_stats_top').value.trim();
            SHEET_IDS.stats_all = document.getElementById('id_stats_all').value.trim();
            SHEET_IDS.active_stats = document.getElementById('active_stats_id').value;
            
            localStorage.setItem(IDS_KEY, JSON.stringify(SHEET_IDS));
            alert("‚úÖ IDs y Bases de Datos guardados.");
            toggleConfig();
            
            // Forzar recarga de base de datos al cambiar IDs
            database = []; 
            syncSheet();
        }

        function toggleConfig() {
            const panel = document.getElementById('config_panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        async function syncSheet() {
            const marketType = document.getElementById('market_auto_select').value;
            const currentSheetID = SHEET_IDS[marketType];
            
            // Obtener el ID de stats activo
            const activeStatsID = SHEET_IDS.active_stats === 'top' ? SHEET_IDS.stats_top : SHEET_IDS.stats_all;

            if(!activeStatsID) {
                alert("‚ö†Ô∏è Por favor configura el ID de la Base de Datos (Stats) en el bot√≥n IDS.");
                return;
            }

            try {
                // Cargar base de datos solo si est√° vac√≠a
                if(database.length === 0) {
                    const statsUrl = `https://docs.google.com/spreadsheets/d/${activeStatsID}/gviz/tq?tqx=out:json`;
                    const statsRes = await fetch(statsUrl);
                    const statsText = await statsRes.text();
                    const statsJson = JSON.parse(statsText.substr(47).slice(0, -2));
                    database = statsJson.table.rows.map(row => ({
                        league: row.c[0]?.v, home: row.c[2]?.v, away: row.c[3]?.v,
                        gl: parseFloat(row.c[4]?.v || 0), gv: parseFloat(row.c[5]?.v || 0)
                    })).filter(r => r.league);
                }

                if(!currentSheetID) {
                    console.warn("No hay ID de mercado configurado para " + marketType);
                    return;
                }

                const autoUrl = `https://docs.google.com/spreadsheets/d/${currentSheetID}/gviz/tq?tqx=out:json`;
                const autoRes = await fetch(autoUrl);
                const autoText = await autoRes.text();
                const autoJson = JSON.parse(autoText.substr(47).slice(0, -2));

                autoMatches = autoJson.table.rows.map(row => {
                    const matchData = {
                        fecha: row.c[0]?.f || row.c[0]?.v,
                        liga: row.c[1]?.v,
                        home: row.c[2]?.v,
                        away: row.c[3]?.v,
                        odd: parseFloat(row.c[4]?.v),
                        marketSource: marketType 
                    };
                    matchData.valueEdge = detectValue(matchData, marketType);
                    return matchData;
                }).filter(m => m.home);

                renderAutoMatches();
                updateLeagueSelect();
                document.getElementById('league_count').innerHTML = `<i class="fa-solid fa-database text-[8px]"></i> ${database.length} Total`;
            } catch (e) { 
                console.error("Sheet Sync Error", e); 
            }
        }

        function detectValue(match, marketType) {
            const hStats = getTeamStats(match.liga, match.home, true);
            const aStats = getTeamStats(match.liga, match.away, false);
            
            if(hStats.count === 0 || aStats.count === 0) return 0;

            const lambdaH = (hStats.fav + aStats.con) / 2;
            const lambdaA = (aStats.fav + hStats.con) / 2;
            
            let probPoisson = 0;
            if(marketType === 'over25' || marketType === 'under25') {
                for(let h=0; h<7; h++) {
                    for(let a=0; a<7; a++) {
                        if (h + a > 2.5) probPoisson += poisson(h, lambdaH) * poisson(a, lambdaA);
                    }
                }
                if(marketType === 'under25') probPoisson = 1 - probPoisson;
            } else if(marketType.startsWith('btts')) {
                for(let h=1; h<7; h++) {
                    for(let a=1; a<7; a++) {
                        probPoisson += poisson(h, lambdaH) * poisson(a, lambdaA);
                    }
                }
                if(marketType === 'btts_no') probPoisson = 1 - probPoisson;
            } else if(marketType === 'over05ht') {
                const lambdaHT = (lambdaH + lambdaA) * 0.44;
                probPoisson = 1 - Math.exp(-lambdaHT);
            }

            const probHouse = 1 / match.odd;
            return (probPoisson - probHouse) * 100;
        }

        function getTeamStats(league, team, isHome) {
            const matches = database.filter(r => r.league === league && (isHome ? r.home === team : r.away === team)).slice(0,10);
            if(matches.length === 0) return { fav:0, con:0, count:0 };
            let gf = 0, gc = 0;
            matches.forEach(m => {
                gf += isHome ? m.gl : m.gv;
                gc += isHome ? m.gv : m.gl;
            });
            return { fav: gf/matches.length, con: gc/matches.length, count: matches.length };
        }

        async function syncAllMarkets() {
            alert("Radar Total Iniciado. Escaneando todos los mercados...");
            const markets = ['over05ht', 'over25', 'under25', 'btts_yes', 'btts_no'];
            let allResults = [];
            
            for(let m of markets) {
                if(!SHEET_IDS[m]) continue;
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_IDS[m]}/gviz/tq?tqx=out:json`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substr(47).slice(0, -2));
                    const results = json.table.rows.map(row => {
                        const matchData = {
                            fecha: row.c[0]?.f || row.c[0]?.v, liga: row.c[1]?.v,
                            home: row.c[2]?.v, away: row.c[3]?.v, odd: parseFloat(row.c[4]?.v),
                            marketLabel: m.toUpperCase().replace('_', ' '),
                            marketSource: m
                        };
                        matchData.valueEdge = detectValue(matchData, m);
                        return matchData;
                    }).filter(r => r.home);
                    allResults = [...allResults, ...results];
                } catch(e) { console.error("Sync Error en " + m); }
            }
            autoMatches = allResults.sort((a,b) => b.valueEdge - a.valueEdge);
            renderAutoMatches();
        }

        function renderAutoMatches() {
            const container = document.getElementById('auto_matches_list');
            container.innerHTML = '';
            
            if(autoMatches.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-600 p-4">Sin datos en el radar...</p>';
                return;
            }

            autoMatches.forEach((m, idx) => {
                const div = document.createElement('div');
                let valueClass = "";
                let badge = "";

                if(m.valueEdge > 10) {
                    valueClass = "card-value-high";
                    badge = `<span class="badge-value-hit">VALUE üî• +${m.valueEdge.toFixed(1)}%</span>`;
                } else if(m.valueEdge > 5) {
                    valueClass = "card-value-mid";
                    badge = `<span class="badge-value-hit" style="background:#00ff88">VALUE +${m.valueEdge.toFixed(1)}%</span>`;
                }

                div.className = `bg-slate-900 border border-white/5 p-3 rounded-lg min-w-[210px] cursor-pointer hover:border-cyan-500 transition-all ${valueClass}`;
                div.onclick = () => selectAutoMatch(idx);
                div.innerHTML = `
                    ${badge}
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[8px] text-slate-500 font-bold uppercase">${m.marketLabel || m.liga}</span>
                        <span class="text-[9px] text-cyan-400 font-bold">${m.odd}</span>
                    </div>
                    <div class="text-[11px] font-black text-white truncate">${m.home}</div>
                    <div class="text-[11px] font-black text-white truncate">${m.away}</div>
                    <div class="text-[8px] text-slate-600 mt-1 font-mono">${m.fecha}</div>
                `;
                container.appendChild(div);
            });
        }

        function selectAutoMatch(idx) {
            const match = autoMatches[idx];
            
            const lSel = document.getElementById('league_select');
            lSel.value = match.liga;
            filterTeamsByLeague();

            document.getElementById('home_select').value = match.home;
            document.getElementById('away_select').value = match.away;
            
            loadStatsIndependent();

            let targetIdx = -1;
            const source = match.marketSource || document.getElementById('market_auto_select').value;
            
            if(source === 'over05ht') targetIdx = 0;
            else if(source === 'over25') targetIdx = 1;
            else if(source === 'under25') targetIdx = 2;
            else if(source === 'btts_yes') targetIdx = 3;
            else if(source === 'btts_no') targetIdx = 4;

            setTimeout(() => {
                const oddInput = document.getElementById(`odd_${targetIdx}`);
                if(oddInput) {
                    oddInput.value = match.odd;
                    const event = new Event('input', { bubbles: true });
                    oddInput.dispatchEvent(event);
                }
            }, 600);
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))];
            const lSel = document.getElementById('league_select');
            lSel.innerHTML = '<option value="">-- ELIGE LIGA --</option>' + 
                             leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function filterTeamsByLeague() {
            const league = document.getElementById('league_select').value;
            const hSel = document.getElementById('home_select');
            const aSel = document.getElementById('away_select');
            const counter = document.getElementById('league_count');

            if(!league) {
                counter.innerHTML = `<i class="fa-solid fa-database text-[8px]"></i> ${database.length} Total`;
                hSel.innerHTML = '<option value="">Liga primero</option>';
                aSel.innerHTML = '<option value="">Liga primero</option>';
                return;
            }

            const leagueMatches = database.filter(r => r.league === league);
            counter.innerHTML = `<i class="fa-solid fa-database text-[8px]"></i> ${leagueMatches.length} Partidos`;

            const teams = [...new Set([...leagueMatches.map(m => m.home), ...leagueMatches.map(m => m.away)])].sort();
            const options = '<option value="">-- EQUIPO --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
            hSel.innerHTML = options;
            aSel.innerHTML = options;
        }

        function loadStatsIndependent() {
            const league = document.getElementById('league_select').value;
            const local = document.getElementById('home_select').value;
            const visita = document.getElementById('away_select').value;
            
            if(!local || !visita) return;

            document.getElementById('league_name').value = league;
            document.getElementById('event_name').value = `${local} vs ${visita}`;

            const homeMatches = database.filter(r => r.league === league && r.home === local).slice(0, 10);
            document.getElementById('home_sample').innerText = `N = ${homeMatches.length}`;
            renderHistory('history-home', homeMatches, true);

            const awayMatches = database.filter(r => r.league === league && r.away === visita).slice(0, 10);
            document.getElementById('away_sample').innerText = `N = ${awayMatches.length}`;
            renderHistory('history-away', awayMatches, false);

            const getStats = (matches, isHome) => {
                if(matches.length === 0) return { fav: 0, con: 0 };
                let gf = 0, gc = 0;
                matches.forEach(m => {
                    gf += isHome ? m.gl : m.gv;
                    gc += isHome ? m.gv : m.gl;
                });
                return { fav: (gf / matches.length).toFixed(2), con: (gc / matches.length).toFixed(2) };
            };

            const hStats = getStats(homeMatches, true);
            const aStats = getStats(awayMatches, false);

            document.getElementById('h_gf').value = hStats.fav;
            document.getElementById('h_gc').value = hStats.con;
            document.getElementById('a_gf').value = aStats.fav;
            document.getElementById('a_gc').value = aStats.con;

            calculate();
        }

        function renderHistory(containerId, matches, isHome) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if(matches.length === 0) {
                container.innerHTML = '<p class="text-[9px] text-slate-600 text-center italic">Sin registros</p>';
                return;
            }
            matches.forEach(m => {
                container.innerHTML += `
                    <div class="history-item">
                        <span class="text-slate-500 truncate mr-2" style="max-width: 60px">${isHome ? m.away : m.home}</span>
                        <span class="font-bold text-white">${m.gl} - ${m.gv}</span>
                    </div>`;
            });
        }

        function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

        function calculate() {
            const h_gf = parseFloat(document.getElementById('h_gf').value) || 0;
            const h_gc = parseFloat(document.getElementById('h_gc').value) || 0;
            const a_gf = parseFloat(document.getElementById('a_gf').value) || 0;
            const a_gc = parseFloat(document.getElementById('a_gc').value) || 0;
            
            if (h_gf === 0 || a_gf === 0) return;
            
            const lambdaH = (h_gf + a_gc) / 2;
            const lambdaA = (a_gf + h_gc) / 2;
            const probsH = Array.from({length: 7}, (_, i) => poisson(i, lambdaH));
            const probsA = Array.from({length: 7}, (_, i) => poisson(i, lambdaA));
            
            let over25 = 0, btts = 0, matrixData = [];
            for(let h=0; h<7; h++) {
                for(let a=0; a<7; a++) {
                    let p = probsH[h] * probsA[a];
                    if (h + a > 2.5) over25 += p;
                    if (h > 0 && a > 0) btts += p;
                    matrixData.push({ score: `${h}-${a}`, p: p });
                }
            }
            const lambdaHT = (lambdaH + lambdaA) * 0.44; 
            const over05HT = 1 - Math.exp(-lambdaHT);
            
            updateMarketUI('res_ht05', 'val_ht05', over05HT);
            updateMarketUI('res_ft25', 'val_ft25', over25);
            updateMarketUI('res_btts', 'val_btts', btts);
            
            renderTable([
                { name: 'OVER 0.5 HT', p: over05HT },
                { name: 'OVER 2.5 FT', p: over25 },
                { name: 'UNDER 2.5 FT', p: 1 - over25 },
                { name: 'BTTS YES', p: btts },
                { name: 'BTTS NO', p: 1 - btts }
            ]);

            renderMatrix(matrixData);
            renderChart(probsH, probsA);
        }

        function updateMarketUI(resId, valId, p) {
            document.getElementById(resId).innerText = (p * 100).toFixed(1) + '%';
            document.getElementById(valId).innerText = `C. Justa: ${(1/p).toFixed(2)}`;
        }

        function renderTable(markets) {
            const body = document.getElementById('market-body');
            body.innerHTML = '';
            markets.forEach((m, i) => {
                const fair = (1/m.p).toFixed(2);
                body.innerHTML += `<tr class="market-row" id="row_${i}">
                    <td class="p-4 font-bold text-slate-300">${m.name}</td>
                    <td class="p-4 text-cyan-400 font-mono">${(m.p*100).toFixed(1)}%</td>
                    <td class="p-4 text-slate-500 font-mono">${fair}</td>
                    <td class="p-4"><input type="number" step="0.01" class="w-16 bg-transparent border border-white/10 rounded text-center text-xs" oninput="calcProbDiff(this, ${m.p}, 'diff_${i}')" id="odd_${i}"></td>
                    <td class="p-4 font-black" id="diff_${i}">--</td>
                    <td class="p-4 text-center">
                        <button onclick="sendToROI(${i}, '${m.name}', ${m.p})" class="bg-cyan-600 hover:bg-cyan-500 text-black text-[10px] font-black px-3 py-1 rounded transition-all">
                            <i class="fa-solid fa-share"></i> ROI
                        </button>
                    </td>
                </tr>`;
            });
        }

        function calcProbDiff(input, probPoisson, diffId) {
            const oddHouse = parseFloat(input.value);
            const diffEl = document.getElementById(diffId);
            if(oddHouse > 1) {
                const probHouse = 1 / oddHouse;
                const diff = probPoisson - probHouse;
                diffEl.innerText = (diff * 100).toFixed(1) + '%';
                diffEl.className = `p-4 font-black ${diff > 0 ? 'text-green-400' : 'text-red-400'}`;
            } else {
                diffEl.innerText = '--';
                diffEl.className = 'p-4 font-black text-slate-500';
            }
        }

        function sendToROI(index, market, prob) {
            const league = document.getElementById('league_name').value || 'S/L';
            const event = document.getElementById('event_name').value || 'Evento';
            const odd = parseFloat(document.getElementById(`odd_${index}`).value);
            const diffText = document.getElementById(`diff_${index}`).innerText;
            if(!odd || odd <= 1) return alert("‚ö†Ô∏è Cuota no v√°lida.");
            
            const newBet = { id: Date.now(), date: new Date().toISOString().split('T')[0], teams: `${league}: ${event}`, market: market, prob: prob, odd: odd, edge: diffText, stake: 1.0, status: 'pending', profit: 0 };
            let bets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            bets.unshift(newBet);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
            
            const btn = document.querySelector(`#row_${index} button`);
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            btn.classList.replace('bg-cyan-600', 'bg-green-500');
            setTimeout(() => { 
                btn.innerHTML = '<i class="fa-solid fa-share"></i> ROI'; 
                btn.classList.replace('bg-green-500', 'bg-cyan-600'); 
            }, 1000);
        }

        function renderMatrix(data) {
            const container = document.getElementById('score-matrix');
            container.innerHTML = '';
            data.sort((a,b) => b.p - a.p).slice(0, 15).forEach(item => {
                container.innerHTML += `<div class="bg-black/40 border border-white/5 p-2 rounded text-center">
                    <div class="text-[10px] text-slate-500 font-bold">${item.score}</div>
                    <div class="text-xs text-cyan-400 font-black">${(item.p*100).toFixed(1)}%</div>
                </div>`;
            });
        }

        function renderChart(h, a) {
            const ctx = document.getElementById('distChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: [0,1,2,3,4,5,6], 
                    datasets: [
                        { label: 'Local', data: h, backgroundColor: '#00f2ff' }, 
                        { label: 'Visita', data: a, backgroundColor: '#00ff88' }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { color: '#475569' } } 
                    } 
                } 
            });
        }

        window.onload = () => {
            loadSavedIDs();
            syncSheet();
        };
    </script>
</body>
</html>