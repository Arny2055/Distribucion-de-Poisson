<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Poisson Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff; /* Cyan BETAGS */
            --sl-green: #00ff88;
            --sl-yellow: #f0db4f;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        input, select { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
            transition: all 0.2s ease; 
        }

        input:focus, select:focus {
            border-color: var(--sl-accent) !important;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
            outline: none;
        }

        .market-row { border-bottom: 1px solid var(--sl-border); transition: background 0.3s; }
        .market-row:hover { background: rgba(255,255,255,0.02); }

        .btn-primary {
            background: #0ea5e9;
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0, 242, 255, 0.5);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #00f2ff;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
            transform: translateY(-1px);
        }

        .btn-depth {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .btn-depth:hover {
            background: #334155;
            color: #fff;
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }

        .badge-value {
            background: rgba(0, 255, 136, 0.1);
            color: var(--sl-green);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .auto-select {
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--sl-accent);
        }

        .match-counter {
            font-size: 9px;
            letter-spacing: 0.5px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sample-badge {
            font-size: 8px;
            background: #1e293b;
            color: var(--sl-accent);
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(0, 242, 255, 0.2);
        }

        .history-item {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--sl-border);
            border-radius: 6px;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .card-value-high {
            border: 1px solid var(--sl-gold) !important;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
            position: relative;
        }

        .card-value-mid {
            border: 1px solid var(--sl-green) !important;
        }

        .badge-value-hit {
            position: absolute;
            top: -8px;
            right: 10px;
            background: var(--sl-gold);
            color: black;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        #config_panel {
            display: none;
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 100;
            width: 320px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.3);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .led-puck {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #475569;
            transition: all 0.3s;
        }
        .led-active { background: var(--sl-green); box-shadow: 0 0 8px var(--sl-green); }
        .led-loading { background: var(--sl-yellow); animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .active-selection-ring {
            border-color: var(--sl-accent) !important;
            box-shadow: 0 0 5px rgba(0, 242, 255, 0.3) !important;
        }

        .league-filter-box {
            background: #05070a;
            border: 1px solid var(--sl-border);
            max-height: 150px;
            overflow-y: auto;
            border-radius: 6px;
            padding: 5px;
        }
        .league-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            font-size: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .league-item:hover { background: rgba(255,255,255,0.05); }
        .league-item input { width: 12px !important; height: 12px !important; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                    <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v4.5 PRO</span></h1>
                </div>
                <div class="status-indicator ml-2">
                    <div id="status_led" class="led-puck"></div>
                    <span id="status_text" class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Standby</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Scanner Mercado</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over05ht">OVER 0.5 HT</option>
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="under25">UNDER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                        <option value="btts_no">BTTS NO</option>
                    </select>
                </div>
                <a href="guia.html" class="text-[10px] font-black bg-slate-800 text-cyan-400 border border-cyan-500/20 px-3 py-1 rounded hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-book-open mr-1"></i> GUÍA
                </a>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-gear mr-1"></i> IDS
                </button>
                <button onclick="syncAllMarkets()" class="text-[10px] font-black bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 px-3 py-1 rounded hover:bg-cyan-600/40 transition-all">
                    <i class="fa-solid fa-satellite-dish mr-1"></i> RADAR VALUE
                </button>
                <a href="roi.html" class="text-xs font-bold text-slate-400 hover:text-cyan-400 transition-colors"><i class="fa-solid fa-chart-pie mr-1"></i> ROI Panel</a>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3"><i class="fa-solid fa-database mr-1"></i> Configura tu herramienta BetAgs</h3>
        <div class="space-y-4">
            <div class="bg-black/20 p-2 rounded border border-white/5">
                <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Base de Datos (Stats)</p>
                <div class="space-y-2">
                    <div>
                        <label class="text-[7px] uppercase text-cyan-500 font-bold">ID para cargar las ligas</label>
                        <input type="text" id="id_stats_top" class="w-full p-2 text-[10px] rounded" placeholder="ID Top Europa...">
                    </div>
                </div>
            </div>

            <div class="bg-black/20 p-2 rounded border border-white/5">
                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Filtro de Ligas Activas</p>
                <div id="league_filter_container" class="league-filter-box">
                    <p class="text-[9px] text-slate-600 p-2 italic text-center">Cargando ligas...</p>
                </div>
            </div>

            <div class="space-y-2">
                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Próximos Partidos (Scanner)</p>
                <div>
                    <input type="text" id="id_over05ht" class="w-full p-2 text-[10px] rounded mb-1" placeholder="ID Over 0.5 HT">
                    <input type="text" id="id_over25" class="w-full p-2 text-[10px] rounded mb-1" placeholder="ID Over 2.5 FT">
                    <input type="text" id="id_under25" class="w-full p-2 text-[10px] rounded mb-1" placeholder="ID Under 2.5 FT">
                    <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] rounded mb-1" placeholder="ID BTTS YES">
                    <input type="text" id="id_btts_no" class="w-full p-2 text-[10px] rounded" placeholder="ID BTTS NO">
                </div>
            </div>
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar Configuración</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="scorelab-card p-3 mb-6 overflow-x-auto">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-[10px] font-black text-cyan-500 uppercase tracking-widest"><i class="fa-solid fa-bolt mr-1"></i> Radar de Próximos Partidos</span>
            </div>
            <div id="auto_matches_list" class="flex gap-3 pb-4 min-w-max">
                <p class="text-xs text-slate-600 p-4">Sincroniza para detectar oportunidades...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">1. Elegir Liga</span>
                    <span id="league_count" class="match-counter">0 Partidos</span>
                </div>
                <select id="league_select" onchange="filterTeamsByLeague()" class="p-2 rounded text-xs auto-select"></select>
            </div>
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">2. Equipo Local</span>
                    <span id="home_sample" class="sample-badge">N = 0</span>
                </div>
                <select id="home_select" onchange="loadStatsIndependent()" class="p-2 rounded text-xs auto-select"></select>
            </div>
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">3. Equipo Visitante</span>
                    <span id="away_sample" class="sample-badge">N = 0</span>
                </div>
                <select id="away_select" onchange="loadStatsIndependent()" class="p-2 rounded text-xs auto-select"></select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest">Data Entry</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="league_name" placeholder="LIGA" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                            <input type="text" id="event_name" placeholder="EVENTO" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="h_gf" step="0.01" placeholder="LOCAL GF" class="p-3 rounded-lg text-center">
                            <input type="number" id="h_gc" step="0.01" placeholder="LOCAL GC" class="p-3 rounded-lg text-center">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="a_gf" step="0.01" placeholder="VISITA GF" class="p-3 rounded-lg text-center">
                            <input type="number" id="a_gc" step="0.01" placeholder="VISITA GC" class="p-3 rounded-lg text-center">
                        </div>
                        <button onclick="calculate()" class="btn-primary py-3 rounded-lg text-[11px]">Analizar</button>
                    </div>
                </div>
                <div class="scorelab-card p-5 h-48">
                    <canvas id="distChart"></canvas>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="scorelab-card p-4 border-l-2 border-cyan-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 0.5 HT</p>
                        <h3 id="res_ht05" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ht05" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-green-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 2.5 FT</p>
                        <h3 id="res_ft25" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ft25" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-yellow-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">BTTS YES</p>
                        <h3 id="res_btts" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_btts" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                            <tr>
                                <th class="p-4">Mercado</th>
                                <th class="p-4">Probabilidad</th>
                                <th class="p-4">Cuota Justa</th>
                                <th class="p-4">Cuota Casa</th>
                                <th class="p-4">Δ Prob (%)</th>
                                <th class="p-4 text-center">ROI</th>
                            </tr>
                        </thead>
                        <tbody id="market-body" class="text-sm"></tbody>
                    </table>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="scorelab-card p-5">
                        <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 text-center">Score Matrix</h2>
                        <div id="score-matrix" class="grid grid-cols-5 gap-2"></div>
                    </div>
                    <div class="scorelab-card p-5">
                        <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 text-center">Últimos 10 Partidos (Bottom Sheet)</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-[8px] text-cyan-500 font-bold mb-2 uppercase text-center">Local (Recientes)</p>
                                <div id="history-home" class="space-y-1"></div>
                            </div>
                            <div>
                                <p class="text-[8px] text-green-500 font-bold mb-2 uppercase text-center">Visita (Recientes)</p>
                                <div id="history-away" class="space-y-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let chart;
        let database = [];
        let autoMatches = []; 
        let selectedLeagues = []; 
        const STORAGE_KEY = 'betags_pre_match';
        const IDS_KEY = 'betags_sheet_ids';
        
        let SHEET_IDS = { over05ht: '', over25: '', under25: '', btts_yes: '', btts_no: '', stats_top: '', stats_all: '', active_stats: 'top' };

        function updateStatus(state, message) {
            const led = document.getElementById('status_led');
            const txt = document.getElementById('status_text');
            led.className = 'led-puck';
            txt.innerText = message;
            if(state === 'loading') led.classList.add('led-loading');
            if(state === 'active') led.classList.add('led-active');
        }

        function loadSavedIDs() {
            const saved = localStorage.getItem(IDS_KEY);
            if(saved) {
                SHEET_IDS = JSON.parse(saved);
                document.getElementById('id_over05ht').value = SHEET_IDS.over05ht || '';
                document.getElementById('id_over25').value = SHEET_IDS.over25 || '';
                document.getElementById('id_under25').value = SHEET_IDS.under25 || '';
                document.getElementById('id_btts_yes').value = SHEET_IDS.btts_yes || '';
                document.getElementById('id_btts_no').value = SHEET_IDS.btts_no || '';
                document.getElementById('id_stats_top').value = SHEET_IDS.stats_top || '';
            }
        }

        function saveIDs() {
            SHEET_IDS.over05ht = document.getElementById('id_over05ht').value.trim();
            SHEET_IDS.over25 = document.getElementById('id_over25').value.trim();
            SHEET_IDS.under25 = document.getElementById('id_under25').value.trim();
            SHEET_IDS.btts_yes = document.getElementById('id_btts_yes').value.trim();
            SHEET_IDS.btts_no = document.getElementById('id_btts_no').value.trim();
            SHEET_IDS.stats_top = document.getElementById('id_stats_top').value.trim();
            localStorage.setItem(IDS_KEY, JSON.stringify(SHEET_IDS));
            alert("✅ Configuración guardada.");
            toggleConfig();
            database = []; 
            syncSheet();
        }

        function toggleConfig() {
            const panel = document.getElementById('config_panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        async function syncSheet() {
            updateStatus('loading', 'Sincronizando...');
            const marketType = document.getElementById('market_auto_select').value;
            const activeStatsID = SHEET_IDS.stats_top;
            if(!activeStatsID) return;

            try {
                if(database.length === 0) {
                    const statsUrl = `https://docs.google.com/spreadsheets/d/${activeStatsID}/gviz/tq?tqx=out:json`;
                    const statsRes = await fetch(statsUrl);
                    const statsText = await statsRes.text();
                    const statsJson = JSON.parse(statsText.substr(47).slice(0, -2));
                    database = statsJson.table.rows.map(row => ({
                        league: row.c[0]?.v, home: row.c[2]?.v, away: row.c[3]?.v,
                        gl: parseFloat(row.c[4]?.v || 0), gv: parseFloat(row.c[5]?.v || 0)
                    })).filter(r => r.league);
                    renderLeagueCheckboxes();
                }

                const currentSheetID = SHEET_IDS[marketType];
                if(currentSheetID) {
                    const autoRes = await fetch(`https://docs.google.com/spreadsheets/d/${currentSheetID}/gviz/tq?tqx=out:json`);
                    const autoText = await autoRes.text();
                    const autoJson = JSON.parse(autoText.substr(47).slice(0, -2));
                    autoMatches = autoJson.table.rows.map(row => ({
                        fecha: row.c[0]?.f || row.c[0]?.v, liga: row.c[1]?.v, home: row.c[2]?.v, away: row.c[3]?.v, odd: parseFloat(row.c[4]?.v), marketSource: marketType 
                    })).filter(m => m.home);
                    renderAutoMatches();
                }
                updateLeagueSelect();
                updateStatus('active', 'Sistema Online');
            } catch (e) { updateStatus('standby', 'Error Sync'); }
        }

        function getTeamStats(league, team, isHome) {
            // MEJORA: Filtramos los partidos del equipo y tomamos los últimos 10 de la lista (los más nuevos)
            const allMatches = database.filter(r => r.league === league && (isHome ? r.home === team : r.away === team));
            const last10 = allMatches.slice(-10); // Toma los últimos 10 del fondo
            
            if(last10.length === 0) return { fav:0, con:0, count:0 };
            let gf = 0, gc = 0;
            last10.forEach(m => {
                gf += isHome ? m.gl : m.gv;
                gc += isHome ? m.gv : m.gl;
            });
            return { fav: gf/last10.length, con: gc/last10.length, count: last10.length };
        }

        function loadStatsIndependent() {
            const league = document.getElementById('league_select').value;
            const local = document.getElementById('home_select').value;
            const visita = document.getElementById('away_select').value;
            if(!local || !visita) return;

            document.getElementById('league_name').value = league;
            document.getElementById('event_name').value = `${local} vs ${visita}`;

            // MEJORA: Capturar los últimos 10 de abajo hacia arriba para la visualización
            const homeMatches = database.filter(r => r.league === league && r.home === local).slice(-10).reverse();
            const awayMatches = database.filter(r => r.league === league && r.away === visita).slice(-10).reverse();

            document.getElementById('home_sample').innerText = `N = ${homeMatches.length}`;
            document.getElementById('away_sample').innerText = `N = ${awayMatches.length}`;
            renderHistory('history-home', homeMatches, true);
            renderHistory('history-away', awayMatches, false);

            const hStats = getTeamStats(league, local, true);
            const aStats = getTeamStats(league, visita, false);

            document.getElementById('h_gf').value = hStats.fav.toFixed(2);
            document.getElementById('h_gc').value = hStats.con.toFixed(2);
            document.getElementById('a_gf').value = aStats.fav.toFixed(2);
            document.getElementById('a_gc').value = aStats.con.toFixed(2);

            calculate();
        }

        function renderHistory(containerId, matches, isHome) {
            const container = document.getElementById(containerId);
            container.innerHTML = matches.map(m => `
                <div class="history-item">
                    <span class="text-slate-500 truncate mr-2" style="max-width: 60px">${isHome ? m.away : m.home}</span>
                    <span class="font-bold text-white">${m.gl} - ${m.gv}</span>
                </div>`).join('') || '<p class="text-[9px] text-slate-600 text-center italic">Sin registros</p>';
        }

        function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

        function calculate() {
            const h_gf = parseFloat(document.getElementById('h_gf').value) || 0;
            const h_gc = parseFloat(document.getElementById('h_gc').value) || 0;
            const a_gf = parseFloat(document.getElementById('a_gf').value) || 0;
            const a_gc = parseFloat(document.getElementById('a_gc').value) || 0;
            
            const lambdaH = (h_gf + a_gc) / 2;
            const lambdaA = (a_gf + h_gc) / 2;
            const probsH = Array.from({length: 7}, (_, i) => poisson(i, lambdaH));
            const probsA = Array.from({length: 7}, (_, i) => poisson(i, lambdaA));
            
            let over25 = 0, btts = 0, matrixData = [];
            for(let h=0; h<7; h++) {
                for(let a=0; a<7; a++) {
                    let p = probsH[h] * probsA[a];
                    if (h + a > 2.5) over25 += p;
                    if (h > 0 && a > 0) btts += p;
                    matrixData.push({ score: `${h}-${a}`, p: p });
                }
            }
            const over05HT = 1 - Math.exp(-(lambdaH + lambdaA) * 0.44);
            
            updateMarketUI('res_ht05', 'val_ht05', over05HT);
            updateMarketUI('res_ft25', 'val_ft25', over25);
            updateMarketUI('res_btts', 'val_btts', btts);
            
            renderTable([
                { name: 'OVER 0.5 HT', p: over05HT },
                { name: 'OVER 2.5 FT', p: over25 },
                { name: 'UNDER 2.5 FT', p: 1 - over25 },
                { name: 'BTTS YES', p: btts },
                { name: 'BTTS NO', p: 1 - btts }
            ]);
            renderMatrix(matrixData);
            renderChart(probsH, probsA);
        }

        function updateMarketUI(resId, valId, p) {
            document.getElementById(resId).innerText = (p * 100).toFixed(1) + '%';
            document.getElementById(valId).innerText = `C. Justa: ${(1/p).toFixed(2)}`;
        }

        function renderTable(markets) {
            const body = document.getElementById('market-body');
            body.innerHTML = markets.map((m, i) => `
                <tr class="market-row">
                    <td class="p-4 font-bold text-slate-300">${m.name}</td>
                    <td class="p-4 text-cyan-400 font-mono">${(m.p*100).toFixed(1)}%</td>
                    <td class="p-4 text-slate-500 font-mono">${(1/m.p).toFixed(2)}</td>
                    <td class="p-4"><input type="number" step="0.01" class="w-16 bg-transparent border border-white/10 rounded text-center text-xs" oninput="calcProbDiff(this, ${m.p}, 'diff_${i}')" id="odd_${i}"></td>
                    <td class="p-4 font-black" id="diff_${i}">--</td>
                    <td class="p-4 text-center"><button class="bg-cyan-600 px-3 py-1 rounded text-black text-[10px] font-black"><i class="fa-solid fa-share"></i></button></td>
                </tr>`).join('');
        }

        function calcProbDiff(input, probPoisson, diffId) {
            const oddHouse = parseFloat(input.value);
            const diffEl = document.getElementById(diffId);
            if(oddHouse > 1) {
                const diff = (probPoisson - (1 / oddHouse)) * 100;
                diffEl.innerText = diff.toFixed(1) + '%';
                diffEl.className = `p-4 font-black ${diff > 0 ? 'text-green-400' : 'text-red-400'}`;
            }
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))].sort();
            document.getElementById('league_select').innerHTML = '<option value="">-- ELIGE LIGA --</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function filterTeamsByLeague() {
            const league = document.getElementById('league_select').value;
            const leagueMatches = database.filter(r => r.league === league);
            const teams = [...new Set([...leagueMatches.map(m => m.home), ...leagueMatches.map(m => m.away)])].sort();
            const options = '<option value="">-- EQUIPO --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('home_select').innerHTML = options;
            document.getElementById('away_select').innerHTML = options;
        }

        function renderLeagueCheckboxes() {
            const container = document.getElementById('league_filter_container');
            const leagues = [...new Set(database.map(r => r.league))].sort();
            container.innerHTML = leagues.map(liga => `
                <div class="league-item">
                    <input type="checkbox" value="${liga}" onchange="updateSelectedLeagues()">
                    <span class="truncate">${liga}</span>
                </div>`).join('');
        }

        function updateSelectedLeagues() {
            const checkboxes = document.querySelectorAll('#league_filter_container input[type="checkbox"]');
            selectedLeagues = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            renderAutoMatches();
        }

        function renderAutoMatches() {
            const container = document.getElementById('auto_matches_list');
            let filtered = autoMatches;
            if(selectedLeagues.length > 0) filtered = autoMatches.filter(m => selectedLeagues.includes(m.liga));
            
            container.innerHTML = filtered.map(m => `
                <div class="bg-slate-900 border border-white/5 p-3 rounded-lg min-w-[210px] cursor-pointer hover:border-cyan-500" onclick='selectAutoMatch(${JSON.stringify(m)})'>
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[8px] text-slate-500 font-bold uppercase">${m.liga}</span>
                        <span class="text-[9px] text-cyan-400 font-bold">${m.odd}</span>
                    </div>
                    <div class="text-[11px] font-black text-white truncate">${m.home}</div>
                    <div class="text-[11px] font-black text-white truncate">${m.away}</div>
                </div>`).join('');
        }

        function selectAutoMatch(match) {
            document.getElementById('league_select').value = match.liga;
            filterTeamsByLeague();
            document.getElementById('home_select').value = match.home;
            document.getElementById('away_select').value = match.away;
            loadStatsIndependent();
        }

        function renderMatrix(data) {
            const container = document.getElementById('score-matrix');
            container.innerHTML = data.sort((a,b) => b.p - a.p).slice(0, 15).map(item => `
                <div class="bg-black/40 border border-white/5 p-2 rounded text-center">
                    <div class="text-[10px] text-slate-500 font-bold">${item.score}</div>
                    <div class="text-xs text-cyan-400 font-black">${(item.p*100).toFixed(1)}%</div>
                </div>`).join('');
        }

        function renderChart(h, a) {
            const ctx = document.getElementById('distChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: [0,1,2,3,4,5,6], datasets: [{ label: 'L', data: h, backgroundColor: '#00f2ff' }, { label: 'V', data: a, backgroundColor: '#00ff88' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#475569' } } } }
            });
        }

        window.onload = () => { loadSavedIDs(); syncSheet(); };
    </script>
</body>
</html>