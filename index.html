<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreLab - Poisson Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff; /* Cyan ScoreLab */
            --sl-green: #00ff88;
            --sl-yellow: #f0db4f;
            --sl-border: #1e222d;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        input { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
            transition: all 0.2s ease; 
        }

        input:focus {
            border-color: var(--sl-accent) !important;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
            outline: none;
        }

        .market-row { border-bottom: 1px solid var(--sl-border); transition: background 0.3s; }
        .market-row:hover { background: rgba(255,255,255,0.02); }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge-value {
            background: rgba(0, 255, 136, 0.1);
            color: var(--sl-green);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">Score<span class="text-cyan-400">Lab</span> <span class="text-[10px] text-slate-500 font-normal">v4.0 Poisson</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <a href="roi.html" class="text-xs font-bold text-slate-400 hover:text-cyan-400 transition-colors"><i class="fa-solid fa-chart-pie mr-1"></i> ROI Panel</a>
                <div class="text-[10px] font-mono text-slate-500 bg-slate-900 px-3 py-1 rounded-full border border-white/5">
                    ENGINE: DIXON-COLES HYBRID
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest"><i class="fa-solid fa-database mr-2"></i>Data Entry</h2>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="league_name" placeholder="LIGA" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                            <input type="text" id="event_name" placeholder="EVENTO" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                        </div>

                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-slate-400">Local: GF Favor / GC Contra</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="h_gf" step="0.01" placeholder="GF" class="p-3 rounded-lg text-center">
                                <input type="number" id="h_gc" step="0.01" placeholder="GC" class="p-3 rounded-lg text-center">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-slate-400">Visita: GF Favor / GC Contra</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="a_gf" step="0.01" placeholder="GF" class="p-3 rounded-lg text-center">
                                <input type="number" id="a_gc" step="0.01" placeholder="GC" class="p-3 rounded-lg text-center">
                            </div>
                        </div>

                        <button onclick="calculate()" class="btn-primary w-full py-4 rounded-xl shadow-lg shadow-cyan-500/20 active:scale-95 transition-transform mt-2">
                            Analizar Probabilidades
                        </button>
                    </div>
                </div>

                <div class="scorelab-card p-5 overflow-hidden">
                    <h2 class="text-[10px] font-black text-slate-500 uppercase mb-3 tracking-widest">Distribución de Probabilidad</h2>
                    <div class="h-48">
                        <canvas id="distChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="scorelab-card p-4 border-l-2 border-cyan-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 0.5 HT</p>
                        <h3 id="res_ht05" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ht05" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-green-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 2.5 FT</p>
                        <h3 id="res_ft25" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ft25" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-yellow-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">BTTS (Ambos Anotan)</p>
                        <h3 id="res_btts" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_btts" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                            <tr>
                                <th class="p-4">Mercado Analizado</th>
                                <th class="p-4">Probabilidad</th>
                                <th class="p-4">Cuota Justa</th>
                                <th class="p-4">Cuota Casa</th>
                                <th class="p-4">Edge (%)</th>
                                <th class="p-4 text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="market-body" class="text-sm">
                            </tbody>
                    </table>
                </div>

                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest text-center">Score Matrix (Top 15)</h2>
                    <div id="score-matrix" class="grid grid-cols-5 gap-2"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let chart;
        const STORAGE_KEY = 'betags_pre_match';

        function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

        function calculate() {
            const h_gf = parseFloat(document.getElementById('h_gf').value) || 0;
            const h_gc = parseFloat(document.getElementById('h_gc').value) || 0;
            const a_gf = parseFloat(document.getElementById('a_gf').value) || 0;
            const a_gc = parseFloat(document.getElementById('a_gc').value) || 0;

            if (h_gf === 0 || a_gf === 0) return;

            const lambdaH = (h_gf + a_gc) / 2;
            const lambdaA = (a_gf + h_gc) / 2;

            const probsH = Array.from({length: 7}, (_, i) => poisson(i, lambdaH));
            const probsA = Array.from({length: 7}, (_, i) => poisson(i, lambdaA));

            let over25 = 0;
            let btts = 0;
            let matrixData = [];

            for(let h=0; h<7; h++) {
                for(let a=0; a<7; a++) {
                    let p = probsH[h] * probsA[a];
                    if (h + a > 2.5) over25 += p;
                    if (h > 0 && a > 0) btts += p;
                    matrixData.push({ score: `${h}-${a}`, p: p });
                }
            }

            const lambdaHT = (lambdaH + lambdaA) * 0.44; 
            const over05HT = 1 - Math.exp(-lambdaHT);

            updateMarketUI('res_ht05', 'val_ht05', over05HT);
            updateMarketUI('res_ft25', 'val_ft25', over25);
            updateMarketUI('res_btts', 'val_btts', btts);

            renderTable([
                { name: 'OVER 0.5 HT', p: over05HT },
                { name: 'OVER 1.5 FT', p: 1 - (probsH[0]*probsA[0] + probsH[1]*probsA[0] + probsH[0]*probsA[1]) },
                { name: 'OVER 2.5 FT', p: over25 },
                { name: 'BTTS YES', p: btts },
                { name: 'GANA LOCAL', p: matrixData.filter(x => parseInt(x.score[0]) > parseInt(x.score[2])).reduce((a, b) => a + b.p, 0) }
            ]);

            renderMatrix(matrixData);
            renderChart(probsH, probsA);
        }

        function updateMarketUI(resId, valId, p) {
            document.getElementById(resId).innerText = (p * 100).toFixed(1) + '%';
            document.getElementById(valId).innerText = `C. Justa: ${(1/p).toFixed(2)}`;
        }

        function renderTable(markets) {
            const body = document.getElementById('market-body');
            body.innerHTML = '';
            markets.forEach((m, i) => {
                const fair = (1/m.p).toFixed(2);
                body.innerHTML += `
                    <tr class="market-row" id="row_${i}">
                        <td class="p-4 font-bold text-slate-300">${m.name}</td>
                        <td class="p-4 text-cyan-400 font-mono">${(m.p*100).toFixed(1)}%</td>
                        <td class="p-4 text-slate-500 font-mono">${fair}</td>
                        <td class="p-4"><input type="number" step="0.01" class="w-16 bg-transparent border border-white/10 rounded text-center text-xs" oninput="calcEdge(this, ${m.p}, 'edge_${i}')" id="odd_${i}"></td>
                        <td class="p-4 font-black" id="edge_${i}">--</td>
                        <td class="p-4 text-center">
                            <button onclick="sendToROI(${i}, '${m.name}', ${m.p})" class="bg-cyan-600 hover:bg-cyan-500 text-black text-[10px] font-black px-3 py-1 rounded transition-all">
                                <i class="fa-solid fa-share"></i> ROI
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function calcEdge(input, prob, edgeId) {
            const odd = parseFloat(input.value);
            const edgeEl = document.getElementById(edgeId);
            if(odd > 1) {
                const edge = (odd * prob) - 1;
                edgeEl.innerText = (edge * 100).toFixed(1) + '%';
                edgeEl.className = `p-4 font-black ${edge > 0 ? 'text-green-400' : 'text-red-400'}`;
            }
        }

        function sendToROI(index, market, prob) {
            const league = document.getElementById('league_name').value || 'S/L';
            const event = document.getElementById('event_name').value || 'Evento';
            const odd = parseFloat(document.getElementById(`odd_${index}`).value);
            const edgeText = document.getElementById(`edge_${index}`).innerText;

            if(!odd || odd <= 1) return alert("⚠️ Ingresa una cuota válida para enviar.");

            const newBet = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                teams: `${league}: ${event}`,
                market: market,
                prob: prob,
                odd: odd,
                edge: edgeText,
                stake: 1.0, // Stake plano por defecto en este modelo
                status: 'pending',
                profit: 0
            };

            let bets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            bets.unshift(newBet);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));

            // Feedback visual
            const btn = document.querySelector(`#row_${index} button`);
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> OK';
            btn.classList.replace('bg-cyan-600', 'bg-green-500');
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.replace('bg-green-500', 'bg-cyan-600');
            }, 2000);
        }

        function renderMatrix(data) {
            const container = document.getElementById('score-matrix');
            container.innerHTML = '';
            data.sort((a,b) => b.p - a.p).slice(0, 15).forEach(item => {
                container.innerHTML += `
                    <div class="bg-black/40 border border-white/5 p-2 rounded text-center">
                        <div class="text-[10px] text-slate-500 font-bold">${item.score}</div>
                        <div class="text-xs text-cyan-400 font-black">${(item.p*100).toFixed(1)}%</div>
                    </div>
                `;
            });
        }

        function renderChart(h, a) {
            const ctx = document.getElementById('distChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [0,1,2,3,4,5,6],
                    datasets: [
                        { label: 'Local', data: h, backgroundColor: '#00f2ff' },
                        { label: 'Visita', data: a, backgroundColor: '#00ff88' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false }, ticks: { color: '#475569' } }
                    }
                }
            });
        }
    </script>
</body>
</html>