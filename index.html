<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Poisson Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff; 
            --sl-green: #00ff88;
            --sl-yellow: #f0db4f;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        input, select { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
            transition: all 0.2s ease; 
        }

        input:focus, select:focus {
            border-color: var(--sl-accent) !important;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
            outline: none;
        }

        .market-row { border-bottom: 1px solid var(--sl-border); transition: background 0.3s; }
        .market-row:hover { background: rgba(255,255,255,0.02); }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Estilos de Value Alert */
        .card-value-high {
            border: 1px solid var(--sl-gold) !important;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
        }
        .card-value-mid {
            border: 1px solid var(--sl-green) !important;
        }
        .badge-value-hit {
            position: absolute;
            top: -8px;
            right: 8px;
            background: var(--sl-gold);
            color: black;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .m-badge {
            font-size: 7px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .mb-over05 { background: #0077ff; color: white; }
        .mb-over25 { background: #00ff88; color: black; }
        .mb-under25 { background: #f0db4f; color: black; }
        .mb-btts { background: #ff0077; color: white; }

        .history-item {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--sl-border);
            border-radius: 6px;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v4.5 Value Engine</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Vista RÃ¡pida</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over05ht">OVER 0.5 HT</option>
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="under25">UNDER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                        <option value="btts_no">BTTS NO</option>
                    </select>
                </div>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-gear mr-1"></i> IDS
                </button>
                <button onclick="syncAllMarkets()" class="text-[10px] font-black bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 px-3 py-1 rounded hover:bg-cyan-600/40 transition-all">
                    <i class="fa-solid fa-bolt-lightning mr-1"></i> RADAR VALUE
                </button>
                <a href="roi.html" class="text-xs font-bold text-slate-400 hover:text-cyan-400 transition-colors"><i class="fa-solid fa-chart-pie mr-1"></i> ROI Panel</a>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3"><i class="fa-solid fa-database mr-1"></i> Configurar IDs de Google Sheets</h3>
        <div class="space-y-3">
            <div>
                <label class="text-[8px] uppercase text-slate-500 font-bold">Over 0.5 HT ID</label>
                <input type="text" id="id_over05ht" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
            </div>
            <div>
                <label class="text-[8px] uppercase text-slate-500 font-bold">Over 2.5 FT ID</label>
                <input type="text" id="id_over25" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
            </div>
            <div>
                <label class="text-[8px] uppercase text-slate-500 font-bold">Under 2.5 FT ID</label>
                <input type="text" id="id_under25" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
            </div>
            <div>
                <label class="text-[8px] uppercase text-slate-500 font-bold">BTTS YES ID</label>
                <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
            </div>
            <div>
                <label class="text-[8px] uppercase text-slate-500 font-bold">BTTS NO ID</label>
                <input type="text" id="id_btts_no" class="w-full p-2 text-[10px] rounded" placeholder="ID del Excel...">
            </div>
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar ConfiguraciÃ³n</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="scorelab-card p-3 mb-6 overflow-x-auto relative">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-[10px] font-black text-cyan-500 uppercase tracking-widest"><i class="fa-solid fa-satellite-dish mr-1"></i> Radar Inteligente de Valor</span>
                <span id="scan_status" class="text-[9px] text-slate-500 font-mono">Poisson Scanner v4.5</span>
            </div>
            <div id="auto_matches_list" class="flex gap-4 pb-3 min-w-max">
                <p class="text-xs text-slate-600 p-4 italic">Usa RADAR VALUE para escanear oportunidades...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">1. Elegir Liga</span>
                    <span id="league_count" class="match-counter"><i class="fa-solid fa-database text-[8px]"></i> 0 Partidos</span>
                </div>
                <select id="league_select" onchange="filterTeamsByLeague()" class="p-2 rounded text-xs auto-select">
                    <option value="">Cargando ligas...</option>
                </select>
            </div>
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">2. Equipo Local</span>
                    <span id="home_sample" class="sample-badge">N = 0</span>
                </div>
                <select id="home_select" onchange="loadStatsIndependent()" class="p-2 rounded text-xs auto-select">
                    <option value="">Liga primero</option>
                </select>
            </div>
            <div class="scorelab-card p-3 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">3. Equipo Visitante</span>
                    <span id="away_sample" class="sample-badge">N = 0</span>
                </div>
                <select id="away_select" onchange="loadStatsIndependent()" class="p-2 rounded text-xs auto-select">
                    <option value="">Liga primero</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest"><i class="fa-solid fa-database mr-2"></i>Data Entry</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="league_name" placeholder="LIGA" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                            <input type="text" id="event_name" placeholder="EVENTO" class="p-2 text-xs rounded uppercase font-bold text-cyan-400">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-slate-400">Local: GF Favor / GC Contra</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="h_gf" step="0.01" placeholder="GF" class="p-3 rounded-lg text-center">
                                <input type="number" id="h_gc" step="0.01" placeholder="GC" class="p-3 rounded-lg text-center">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-slate-400">Visita: GF Favor / GC Contra</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="a_gf" step="0.01" placeholder="GF" class="p-3 rounded-lg text-center">
                                <input type="number" id="a_gc" step="0.01" placeholder="GC" class="p-3 rounded-lg text-center">
                            </div>
                        </div>
                        <button onclick="calculate()" class="btn-primary w-full py-4 rounded-xl shadow-lg shadow-cyan-500/20 active:scale-95 transition-transform mt-2">Analizar Probabilidades</button>
                    </div>
                </div>
                <div class="scorelab-card p-5 overflow-hidden">
                    <h2 class="text-[10px] font-black text-slate-500 uppercase mb-3 tracking-widest">DistribuciÃ³n</h2>
                    <div class="h-48"><canvas id="distChart"></canvas></div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="scorelab-card p-4 border-l-2 border-cyan-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 0.5 HT</p>
                        <h3 id="res_ht05" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ht05" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-green-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Over 2.5 FT</p>
                        <h3 id="res_ft25" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_ft25" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-yellow-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">BTTS YES</p>
                        <h3 id="res_btts" class="text-2xl font-black text-white">0.0%</h3>
                        <div id="val_btts" class="badge-value mt-1 w-fit">C. Justa: --</div>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                            <tr>
                                <th class="p-4">Mercado Analizado</th>
                                <th class="p-4">Probabilidad</th>
                                <th class="p-4">Cuota Justa</th>
                                <th class="p-4">Cuota Casa</th>
                                <th class="p-4">Î” Prob (%)</th>
                                <th class="p-4 text-center">AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody id="market-body" class="text-sm"></tbody>
                    </table>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="scorelab-card p-5">
                        <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest text-center">Matrix (Top 15)</h2>
                        <div id="score-matrix" class="grid grid-cols-5 gap-2"></div>
                    </div>
                    <div class="scorelab-card p-5">
                        <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest text-center">Muestra</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div><div id="history-home" class="space-y-1"></div></div>
                            <div><div id="history-away" class="space-y-1"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let chart;
        let database = [];
        let autoMatches = []; 
        const STORAGE_KEY = 'betags_pre_match';
        const IDS_KEY = 'betags_sheet_ids';
        const STATS_SHEET_ID = '1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO';
        
        let SHEET_IDS = { over05ht: '', over25: '', under25: '', btts_yes: '', btts_no: '' };

        function loadSavedIDs() {
            const saved = localStorage.getItem(IDS_KEY);
            if(saved) {
                SHEET_IDS = JSON.parse(saved);
                document.getElementById('id_over05ht').value = SHEET_IDS.over05ht || '';
                document.getElementById('id_over25').value = SHEET_IDS.over25 || '';
                document.getElementById('id_under25').value = SHEET_IDS.under25 || '';
                document.getElementById('id_btts_yes').value = SHEET_IDS.btts_yes || '';
                document.getElementById('id_btts_no').value = SHEET_IDS.btts_no || '';
            }
        }

        function saveIDs() {
            SHEET_IDS.over05ht = document.getElementById('id_over05ht').value.trim();
            SHEET_IDS.over25 = document.getElementById('id_over25').value.trim();
            SHEET_IDS.under25 = document.getElementById('id_under25').value.trim();
            SHEET_IDS.btts_yes = document.getElementById('id_btts_yes').value.trim();
            SHEET_IDS.btts_no = document.getElementById('id_btts_no').value.trim();
            localStorage.setItem(IDS_KEY, JSON.stringify(SHEET_IDS));
            alert("âœ… IDs guardados.");
            toggleConfig();
        }

        function toggleConfig() {
            const panel = document.getElementById('config_panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        // --- SISTEMA DE VALUE ALERT ---
        function getProbPoisson(match, mType) {
            const leagueMatches = database.filter(r => r.league === match.liga);
            const homeMatches = leagueMatches.filter(r => r.home === match.home).slice(0, 10);
            const awayMatches = leagueMatches.filter(r => r.away === match.away).slice(0, 10);
            
            if(homeMatches.length < 3 || awayMatches.length < 3) return 0;

            const getAvg = (matches, isHome) => {
                let gf = 0, gc = 0;
                matches.forEach(m => { gf += isHome ? m.gl : m.gv; gc += isHome ? m.gv : m.gl; });
                return { fav: gf/matches.length, con: gc/matches.length };
            };

            const hStats = getAvg(homeMatches, true);
            const aStats = getAvg(awayMatches, false);
            const lambdaH = (hStats.fav + aStats.con) / 2;
            const lambdaA = (aStats.fav + hStats.con) / 2;

            if(mType === 'over05ht') return 1 - Math.exp(-((lambdaH + lambdaA) * 0.44));

            let prob = 0;
            for(let h=0; h<7; h++) {
                for(let a=0; a<7; a++) {
                    let p = poisson(h, lambdaH) * poisson(a, lambdaA);
                    if(mType === 'over25' && h+a > 2.5) prob += p;
                    if(mType === 'under25' && h+a < 2.5) prob += p;
                    if(mType === 'btts_yes' && h>0 && a>0) prob += p;
                    if(mType === 'btts_no' && (h===0 || a===0)) prob += p;
                }
            }
            return prob;
        }

        async function syncAllMarkets() {
            await fetchStatsDB();
            const markets = ['over05ht', 'over25', 'under25', 'btts_yes', 'btts_no'];
            autoMatches = [];
            document.getElementById('auto_matches_list').innerHTML = '<p class="text-xs text-cyan-400 p-4 animate-pulse">ðŸ“¡ ESCANEANDO MERCADOS...</p>';

            for(let mType of markets) {
                const id = SHEET_IDS[mType];
                if(!id) continue;
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substr(47).slice(0, -2));
                    const matches = json.table.rows.map(row => {
                        const m = {
                            fecha: row.c[0]?.f || row.c[0]?.v,
                            liga: row.c[1]?.v,
                            home: row.c[2]?.v,
                            away: row.c[3]?.v,
                            odd: parseFloat(row.c[4]?.v || 0),
                            mType: mType
                        };
                        const prob = getProbPoisson(m, mType);
                        m.valueEdge = prob > 0 ? (prob - (1/m.odd)) * 100 : -99;
                        return m;
                    }).filter(r => r.home);
                    autoMatches = [...autoMatches, ...matches];
                } catch(e) {}
            }
            autoMatches.sort((a,b) => b.valueEdge - a.valueEdge);
            renderAutoMatches();
        }

        async function fetchStatsDB() {
            const url = `https://docs.google.com/spreadsheets/d/${STATS_SHEET_ID}/gviz/tq?tqx=out:json`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substr(47).slice(0, -2));
            database = json.table.rows.map(row => ({
                league: row.c[0]?.v, home: row.c[2]?.v, away: row.c[3]?.v,
                gl: parseFloat(row.c[4]?.v || 0), gv: parseFloat(row.c[5]?.v || 0)
            })).filter(r => r.league);
            updateLeagueSelect();
        }

        async function syncSheet() {
            await fetchStatsDB();
            const marketType = document.getElementById('market_auto_select').value;
            const id = SHEET_IDS[marketType];
            if(!id) return alert("Configura el ID");
            const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substr(47).slice(0, -2));
            autoMatches = json.table.rows.map(row => {
                const m = {
                    fecha: row.c[0]?.f || row.c[0]?.v, liga: row.c[1]?.v,
                    home: row.c[2]?.v, away: row.c[3]?.v, odd: parseFloat(row.c[4]?.v || 0),
                    mType: marketType
                };
                const prob = getProbPoisson(m, marketType);
                m.valueEdge = prob > 0 ? (prob - (1/m.odd)) * 100 : -99;
                return m;
            }).filter(r => r.home);
            renderAutoMatches();
        }

        function renderAutoMatches() {
            const container = document.getElementById('auto_matches_list');
            container.innerHTML = '';
            autoMatches.forEach((m, idx) => {
                const div = document.createElement('div');
                let vClass = m.valueEdge > 10 ? 'card-value-high' : (m.valueEdge > 5 ? 'card-value-mid' : '');
                let mBadge = m.mType === 'over05ht' ? 'mb-over05' : (m.mType === 'over25' ? 'mb-over25' : (m.mType === 'under25' ? 'mb-under25' : 'mb-btts'));
                
                div.className = `bg-slate-900 border border-white/5 p-3 rounded-lg min-w-[200px] cursor-pointer hover:border-cyan-500 transition-all relative ${vClass}`;
                div.onclick = () => selectAutoMatch(idx);
                div.innerHTML = `
                    ${m.valueEdge > 5 ? `<span class="badge-value-hit">VALUE ðŸ”¥ +${m.valueEdge.toFixed(1)}%</span>` : ''}
                    <div class="flex justify-between items-start mb-1">
                        <span class="m-badge ${mBadge}">${m.mType.replace('_',' ')}</span>
                        <span class="text-[9px] text-cyan-400 font-bold">${m.odd}</span>
                    </div>
                    <div class="text-[11px] font-black text-white truncate">${m.home}</div>
                    <div class="text-[11px] font-black text-white truncate">${m.away}</div>
                    <div class="text-[8px] text-slate-600 mt-1 font-mono">${m.liga}</div>
                `;
                container.appendChild(div);
            });
        }

        function selectAutoMatch(idx) {
            const match = autoMatches[idx];
            document.getElementById('league_select').value = match.liga;
            filterTeamsByLeague();
            document.getElementById('home_select').value = match.home;
            document.getElementById('away_select').value = match.away;
            loadStatsIndependent();

            let targetIdx = 1;
            if(match.mType === 'over05ht') targetIdx = 0;
            if(match.mType === 'under25') targetIdx = 2;
            if(match.mType.startsWith('btts')) targetIdx = match.mType === 'btts_yes' ? 3 : 4;

            setTimeout(() => {
                const input = document.getElementById(`odd_${targetIdx}`);
                if(input) { input.value = match.odd; input.dispatchEvent(new Event('input')); }
            }, 500);
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))];
            const lSel = document.getElementById('league_select');
            lSel.innerHTML = '<option value="">-- LIGA --</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function filterTeamsByLeague() {
            const league = document.getElementById('league_select').value;
            const teams = [...new Set([...database.filter(r=>r.league===league).map(m=>m.home), ...database.filter(r=>r.league===league).map(m=>m.away)])].sort();
            const options = '<option value="">-- EQUIPO --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('home_select').innerHTML = options;
            document.getElementById('away_select').innerHTML = options;
        }

        function loadStatsIndependent() {
            const league = document.getElementById('league_select').value;
            const local = document.getElementById('home_select').value;
            const visita = document.getElementById('away_select').value;
            if(!local || !visita) return;
            document.getElementById('league_name').value = league;
            document.getElementById('event_name').value = `${local} vs ${visita}`;
            const hMs = database.filter(r => r.league === league && r.home === local).slice(0, 10);
            const aMs = database.filter(r => r.league === league && r.away === visita).slice(0, 10);
            const getStats = (ms, isH) => {
                let gf = 0, gc = 0;
                ms.forEach(m => { gf += isH ? m.gl : m.gv; gc += isH ? m.gv : m.gl; });
                return { fav: (gf/ms.length || 0).toFixed(2), con: (gc/ms.length || 0).toFixed(2) };
            };
            const hS = getStats(hMs, true); const aS = getStats(aMs, false);
            document.getElementById('h_gf').value = hS.fav; document.getElementById('h_gc').value = hS.con;
            document.getElementById('a_gf').value = aS.fav; document.getElementById('a_gc').value = aS.con;
            calculate();
        }

        function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

        function calculate() {
            const h_gf = parseFloat(document.getElementById('h_gf').value) || 0;
            const h_gc = parseFloat(document.getElementById('h_gc').value) || 0;
            const a_gf = parseFloat(document.getElementById('a_gf').value) || 0;
            const a_gc = parseFloat(document.getElementById('a_gc').value) || 0;
            if (h_gf === 0 || a_gf === 0) return;
            const lambdaH = (h_gf + a_gc) / 2;
            const lambdaA = (a_gf + h_gc) / 2;
            const probsH = Array.from({length: 7}, (_, i) => poisson(i, lambdaH));
            const probsA = Array.from({length: 7}, (_, i) => poisson(i, lambdaA));
            let over25 = 0, btts = 0, matrixData = [];
            for(let h=0; h<7; h++) {
                for(let a=0; a<7; a++) {
                    let p = probsH[h] * probsA[a];
                    if (h + a > 2.5) over25 += p;
                    if (h > 0 && a > 0) btts += p;
                    matrixData.push({ score: `${h}-${a}`, p: p });
                }
            }
            const over05HT = 1 - Math.exp(-((lambdaH + lambdaA) * 0.44));
            updateMarketUI('res_ht05', 'val_ht05', over05HT);
            updateMarketUI('res_ft25', 'val_ft25', over25);
            updateMarketUI('res_btts', 'val_btts', btts);
            renderTable([{ name: 'OVER 0.5 HT', p: over05HT }, { name: 'OVER 2.5 FT', p: over25 }, { name: 'UNDER 2.5 FT', p: 1 - over25 }, { name: 'BTTS YES', p: btts }, { name: 'BTTS NO', p: 1 - btts }]);
            renderMatrix(matrixData); renderChart(probsH, probsA);
        }

        function updateMarketUI(r, v, p) {
            document.getElementById(r).innerText = (p * 100).toFixed(1) + '%';
            document.getElementById(v).innerText = `C. Justa: ${(1/p).toFixed(2)}`;
        }

        function renderTable(ms) {
            const body = document.getElementById('market-body'); body.innerHTML = '';
            ms.forEach((m, i) => {
                body.innerHTML += `<tr class="market-row" id="row_${i}">
                    <td class="p-4 font-bold text-slate-300">${m.name}</td>
                    <td class="p-4 text-cyan-400 font-mono">${(m.p*100).toFixed(1)}%</td>
                    <td class="p-4 text-slate-500 font-mono">${(1/m.p).toFixed(2)}</td>
                    <td class="p-4"><input type="number" step="0.01" class="w-16 bg-transparent border border-white/10 rounded text-center text-xs" oninput="calcProbDiff(this, ${m.p}, 'diff_${i}')" id="odd_${i}"></td>
                    <td class="p-4 font-black" id="diff_${i}">--</td>
                    <td class="p-4 text-center"><button onclick="sendToROI(${i}, '${m.name}', ${m.p})" class="bg-cyan-600 hover:bg-cyan-500 text-black text-[10px] font-black px-3 py-1 rounded transition-all">ROI</button></td>
                </tr>`;
            });
        }

        function calcProbDiff(i, p, d) {
            const o = parseFloat(i.value);
            const el = document.getElementById(d);
            if(o > 1) {
                const diff = p - (1/o);
                el.innerText = (diff * 100).toFixed(1) + '%';
                el.className = `p-4 font-black ${diff > 0 ? 'text-green-400' : 'text-red-400'}`;
            }
        }

        function sendToROI(i, m, p) {
            const l = document.getElementById('league_name').value;
            const e = document.getElementById('event_name').value;
            const o = parseFloat(document.getElementById(`odd_${i}`).value);
            if(!o) return alert("Ingresa cuota");
            let bets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            bets.unshift({ id: Date.now(), teams: `${l}: ${e}`, market: m, prob: p, odd: o, status: 'pending' });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
            alert("Enviado a ROI");
        }

        function renderMatrix(d) {
            const container = document.getElementById('score-matrix'); container.innerHTML = '';
            d.sort((a,b) => b.p - a.p).slice(0, 15).forEach(item => {
                container.innerHTML += `<div class="bg-black/40 border border-white/5 p-2 rounded text-center"><div class="text-[10px] text-slate-500 font-bold">${item.score}</div><div class="text-xs text-cyan-400 font-black">${(item.p*100).toFixed(1)}%</div></div>`;
            });
        }

        function renderChart(h, a) {
            const ctx = document.getElementById('distChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, { type: 'bar', data: { labels: [0,1,2,3,4,5,6], datasets: [{ label: 'Local', data: h, backgroundColor: '#00f2ff' }, { label: 'Visita', data: a, backgroundColor: '#00ff88' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#475569' } } } } });
        }

        window.onload = loadSavedIDs;
    </script>
</body>
</html>