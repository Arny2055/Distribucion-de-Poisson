<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BETAGS - Quantum Backtester v5.5 PRO</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
--sl-dark:#080a0f;
--sl-card:#11141d;
--sl-accent:#00f2ff;
--sl-green:#00ff88;
--sl-red:#ff4d4d;
--sl-border:#1e222d;
--sl-gold:#ffcc00;
}

body{
background-color:var(--sl-dark);
color:#e2e8f0;
font-family:'Inter',sans-serif;
background-image:radial-gradient(circle at 50% -20%,#1e293b 0%,var(--sl-dark) 80%);
min-height:100vh;
}

.scorelab-card{
background:var(--sl-card);
border:1px solid var(--sl-border);
border-radius:12px;
}

input,select{
background-color:#05070a!important;
color:white!important;
border:1px solid var(--sl-border)!important;
}

.btn-primary{
background:linear-gradient(135deg,#00f2ff 0%,#0077ff 100%);
color:black;
font-weight:900;
text-transform:uppercase;
}

.backtest-win{color:var(--sl-green);font-weight:bold;}
.backtest-loss{color:var(--sl-red);font-weight:bold;}

.profit-positive{color:var(--sl-green);}
.profit-negative{color:var(--sl-red);}

.sample-30{color:#38bdf8;font-weight:bold;}
.sample-50{color:#facc15;font-weight:bold;}
.sample-100{color:#00ff88;font-weight:bold;}

#config_panel{
display:none;
position:absolute;
top:70px;
right:20px;
z-index:100;
width:300px;
}
</style>
</head>

<body>

<nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
<div class="container mx-auto flex justify-between items-center">
<h1 class="text-xl font-black uppercase">BETA<span class="text-cyan-400">GS</span> v5.5 PRO</h1>
<select id="market_auto_select" onchange="syncSheet()" class="text-xs text-cyan-400 font-bold">
<option value="over05ht">OVER 0.5 HT</option>
<option value="over25">OVER 2.5 FT</option>
<option value="btts_yes">BTTS YES</option>
</select>
</div>
</nav>

<main class="container mx-auto p-4 max-w-7xl">

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="scorelab-card p-3">
<label class="text-xs">Liga</label>
<select id="league_select" onchange="filterTeamsByLeague()" class="w-full p-2 rounded text-xs mt-1"></select>
</div>

<div class="scorelab-card p-3">
<label class="text-xs">Equipo</label>
<select id="team_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
</div>

<div class="scorelab-card p-3">
<label class="text-xs">Posición</label>
<select id="position_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1">
<option value="home">LOCAL</option>
<option value="away">VISITANTE</option>
</select>
</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

<div class="lg:col-span-8 space-y-4">

<div class="grid grid-cols-2 md:grid-cols-5 gap-4">

<div class="scorelab-card p-4">
<p class="text-xs">Muestra</p>
<h3 id="bt_total" class="text-xl font-black">0</h3>
</div>

<div class="scorelab-card p-4">
<p class="text-xs">Winrate</p>
<h3 id="bt_winrate" class="text-xl font-black">0%</h3>
</div>

<div class="scorelab-card p-4">
<p class="text-xs">Profit</p>
<h3 id="bt_profit" class="text-xl font-black">0.00</h3>
</div>

<div class="scorelab-card p-4">
<p class="text-xs">ROI</p>
<h3 id="bt_roi" class="text-xl font-black">0%</h3>
</div>

<div class="scorelab-card p-4">
<p class="text-xs">Max DD</p>
<h3 id="bt_dd" class="text-xl font-black">0</h3>
</div>

</div>

<div class="scorelab-card overflow-hidden">
<div class="overflow-x-auto">
<table class="w-full text-xs">
<thead class="bg-black/40 uppercase text-slate-500">
<tr>
<th class="p-2">#</th>
<th class="p-2">Fecha</th>
<th class="p-2">Partido</th>
<th class="p-2">Res</th>
<th class="p-2">Cuota</th>
<th class="p-2">Estado</th>
<th class="p-2">Profit</th>
<th class="p-2">Profit Acum</th>
<th class="p-2">Muestra</th>
</tr>
</thead>
<tbody id="backtest_body"></tbody>
</table>
</div>
</div>
</div>

<div class="lg:col-span-4">
<div class="scorelab-card p-5 h-80">
<canvas id="profitChart"></canvas>
</div>
</div>

</div>
</main>

<script>

let database=[];
let marketData=[];
let profitChart;

const STATS_SHEET_ID='1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO';

async function syncSheet(){
try{

const url=`https://docs.google.com/spreadsheets/d/${STATS_SHEET_ID}/gviz/tq?tqx=out:json`;
const res=await fetch(url);
const text=await res.text();
const json=JSON.parse(text.substr(47).slice(0,-2));

database=json.table.rows.map((row,index)=>({
id:index,
league:row.c[0]?.v,
date:row.c[1]?.f||row.c[1]?.v,
home:row.c[2]?.v,
away:row.c[3]?.v,
gl:parseFloat(row.c[4]?.v||0),
gv:parseFloat(row.c[5]?.v||0),
gl_ht:parseFloat(row.c[6]?.v||0),
gv_ht:parseFloat(row.c[7]?.v||0)
}));

updateLeagueSelect();

}catch(e){console.log(e);}
}

function updateLeagueSelect(){
const leagues=[...new Set(database.map(r=>r.league))].sort();
const sel=document.getElementById('league_select');
sel.innerHTML='<option>--</option>'+leagues.map(l=>`<option>${l}</option>`).join('');
}

function filterTeamsByLeague(){
const league=document.getElementById('league_select').value;
const teams=[...new Set(database.filter(r=>r.league===league).map(r=>r.home))].sort();
const sel=document.getElementById('team_select');
sel.innerHTML='<option>--</option>'+teams.map(t=>`<option>${t}</option>`).join('');
}

function runBacktest(){

const league=document.getElementById('league_select').value;
const team=document.getElementById('team_select').value;
const position=document.getElementById('position_select').value;
const marketType=document.getElementById('market_auto_select').value;

if(!team||team==='--')return;

let matches=database.filter(r=>
r.league===league&&(position==='home'?r.home===team:r.away===team)
);

matches=matches.reverse();

const tbody=document.getElementById('backtest_body');
tbody.innerHTML='';

let wins=0;
let totalProfit=0;
let count=0;
let chartData=[];
let peak=0;
let maxDD=0;
let totalOdds=0;

matches.forEach((m,index)=>{

const odd=1.85;
let isWin=false;

const totalG=m.gl+m.gv;
const totalHT=m.gl_ht+m.gv_ht;

if(marketType==='over25')isWin=totalG>2.5;
if(marketType==='over05ht')isWin=totalHT>0.5;
if(marketType==='btts_yes')isWin=m.gl>0&&m.gv>0;

const profit=isWin?(odd-1):-1;

if(isWin)wins++;
totalProfit+=profit;
count++;
totalOdds+=odd;

if(totalProfit>peak)peak=totalProfit;
let dd=peak-totalProfit;
if(dd>maxDD)maxDD=dd;

chartData.push(totalProfit.toFixed(2));

let sampleClass='';
if(count>=100)sampleClass='sample-100';
else if(count>=50)sampleClass='sample-50';
else if(count>=30)sampleClass='sample-30';

tbody.innerHTML+=`
<tr class="border-b border-white/5">
<td class="p-2">${index+1}</td>
<td class="p-2">${m.date}</td>
<td class="p-2">${m.home} vs ${m.away}</td>
<td class="p-2">${isWin?'✅':'❌'}</td>
<td class="p-2">${odd.toFixed(2)}</td>
<td class="p-2 ${isWin?'backtest-win':'backtest-loss'}">${isWin?'WIN':'LOSS'}</td>
<td class="p-2 ${profit>=0?'profit-positive':'profit-negative'}">${profit.toFixed(2)}</td>
<td class="p-2 font-bold ${totalProfit>=0?'profit-positive':'profit-negative'}">${totalProfit.toFixed(2)}</td>
<td class="p-2 ${sampleClass}">${count}</td>
</tr>
`;

});

const roi=count>0?((totalProfit/count)*100):0;
const avgOdd=count>0?(totalOdds/count):0;

document.getElementById('bt_total').innerText=count;
document.getElementById('bt_winrate').innerText=count>0?((wins/count)*100).toFixed(1)+'%':'0%';
document.getElementById('bt_profit').innerText=totalProfit.toFixed(2);
document.getElementById('bt_roi').innerText=roi.toFixed(2)+'%';
document.getElementById('bt_dd').innerText=maxDD.toFixed(2);

updateChart(chartData);

}

function updateChart(data){

const ctx=document.getElementById('profitChart').getContext('2d');
if(profitChart)profitChart.destroy();

profitChart=new Chart(ctx,{
type:'line',
data:{
labels:data.map((_,i)=>i+1),
datasets:[
{
label:'Profit',
data:data,
borderColor:'#00f2ff',
backgroundColor:'rgba(0,242,255,0.1)',
fill:true,
tension:0.3,
pointRadius:1
},
{
label:'Break Even',
data:data.map(()=>0),
borderColor:'#ff4d4d',
borderDash:[5,5],
pointRadius:0
}
]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{display:false}},
scales:{
y:{grid:{color:'rgba(255,255,255,0.05)'}},
x:{display:false}
}
}
});

}

window.onload=syncSheet;

</script>

</body>
</html>