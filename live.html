<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Quantum Backtester v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff;
            --sl-green: #00ff88;
            --sl-red: #ff4d4d;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
        }

        input, select { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
        }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
        }

        .backtest-win { color: var(--sl-green); font-weight: bold; }
        .backtest-loss { color: var(--sl-red); font-weight: bold; }
        .backtest-nobet { color: #64748b; font-weight: bold; font-style: italic; }
        
        .profit-positive { color: var(--sl-green); text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .profit-negative { color: var(--sl-red); text-shadow: 0 0 10px rgba(255,77,77,0.3); }

        #config_panel {
            display: none;
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 100;
            width: 320px;
        }

        .badge-stake {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 900;
        }
        .s1 { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
        .s2 { background: rgba(0, 242, 255, 0.1); color: var(--sl-accent); border: 1px solid rgba(0, 242, 255, 0.3); }
        .s3 { background: rgba(255, 204, 0, 0.1); color: var(--sl-gold); border: 1px solid rgba(255, 204, 0, 0.3); }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v5.0 BACKTESTER</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Mercado a Validar</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="under25">UNDER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                        <option value="btts_no">BTTS NO</option>
                    </select>
                </div>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded">
                    <i class="fa-solid fa-gear mr-1"></i> CONFIGURACIÓN
                </button>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl overflow-y-auto max-h-[80vh]">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3">Ajustes Avanzados</h3>
        <div class="space-y-3">
            <div class="bg-cyan-500/10 p-2 rounded border border-cyan-500/20">
                <label class="text-[8px] text-cyan-400 font-bold uppercase block mb-1">Margen de Valor Mínimo (%)</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="value_margin_range" min="0" max="20" value="5" oninput="updateMarginLabel(this.value)" class="flex-1">
                    <span id="margin_label" class="text-xs font-black text-white w-8">5%</span>
                </div>
            </div>
            
            <div class="bg-black/40 p-2 rounded border border-white/5">
                <label class="text-[8px] text-slate-400 font-bold uppercase block mb-2">Umbrales de Activación Kelly (%)</label>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[7px] text-slate-500 uppercase">Min (S1 a S2)</label>
                        <input type="number" id="kelly_min_threshold" class="w-full p-1 text-[10px] rounded" value="2" step="0.1">
                    </div>
                    <div>
                        <label class="text-[7px] text-slate-500 uppercase">Max (S2 a S3)</label>
                        <input type="number" id="kelly_max_threshold" class="w-full p-1 text-[10px] rounded" value="4" step="0.1">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="text-[7px] text-slate-400 uppercase">Stake 1 (%)</label>
                    <input type="number" id="s1_val" class="w-full p-1 text-[10px] rounded" value="1" step="0.5">
                </div>
                <div>
                    <label class="text-[7px] text-slate-400 uppercase">Stake 2 (%)</label>
                    <input type="number" id="s2_val" class="w-full p-1 text-[10px] rounded" value="2" step="0.5">
                </div>
                <div>
                    <label class="text-[7px] text-slate-400 uppercase">Stake 3 (%)</label>
                    <input type="number" id="s3_val" class="w-full p-1 text-[10px] rounded" value="3" step="0.5">
                </div>
            </div>

            <div>
                <label class="text-[8px] text-slate-400 uppercase">Bankroll Inicial</label>
                <input type="number" id="initial_bankroll" class="w-full p-2 text-[10px] rounded" value="1000">
            </div>

            <hr class="border-white/5">
            <div>
                <label class="text-[8px] text-slate-400 uppercase">IDs de Hojas</label>
                <input type="text" id="id_over25" class="w-full p-2 text-[10px] mb-1 rounded" placeholder="Over 2.5 ID">
                <input type="text" id="id_under25" class="w-full p-2 text-[10px] mb-1 rounded" placeholder="Under 2.5 ID">
                <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] mb-1 rounded" placeholder="BTTS Yes ID">
                <input type="text" id="id_btts_no" class="w-full p-2 text-[10px] rounded" placeholder="BTTS No ID">
            </div>
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar y Recalcular</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">1. Liga</label>
                <select id="league_select" onchange="filterTeamsByLeague()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">2. Seleccionar Equipo</label>
                <select id="team_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">3. Posición en Backtest</label>
                <select id="position_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1">
                    <option value="home">COMO LOCAL (Análisis Histórico)</option>
                    <option value="away">COMO VISITANTE (Análisis Histórico)</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="scorelab-card p-4 border-l-2 border-cyan-500">
                <p class="text-[9px] font-bold text-slate-500 uppercase">Apuestas Filtradas</p>
                <h3 id="bt_total" class="text-2xl font-black">0</h3>
            </div>
            <div class="scorelab-card p-4 border-l-2 border-green-500">
                <p class="text-[9px] font-bold text-slate-500 uppercase">Efectividad (WR)</p>
                <h3 id="bt_winrate" class="text-2xl font-black">0%</h3>
            </div>
            <div class="scorelab-card p-4 border-l-2 border-yellow-500">
                <p class="text-[9px] font-bold text-slate-500 uppercase">Profit Unidades</p>
                <h3 id="bt_profit" class="text-2xl font-black">0.00</h3>
            </div>
            <div class="scorelab-card p-4 border-l-2 border-purple-500">
                <p class="text-[9px] font-bold text-slate-500 uppercase">Balance Bankroll</p>
                <h3 id="bt_balance" class="text-2xl font-black">0.00</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 space-y-4">
                <div class="scorelab-card overflow-hidden">
                    <div class="p-3 border-b border-white/5 bg-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase tracking-widest text-cyan-400">Backtest: Kelly Dynamic Mapping</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                                <tr>
                                    <th class="p-3">#</th>
                                    <th class="p-3">Partido</th>
                                    <th class="p-3">Poisson vs Casa</th>
                                    <th class="p-3">Kelly Sug.</th>
                                    <th class="p-3">Stake</th>
                                    <th class="p-3">Cuota</th>
                                    <th class="p-3">Estado</th>
                                    <th class="p-3">Profit</th>
                                </tr>
                            </thead>
                            <tbody id="backtest_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest">Configuración Umbrales</h2>
                    <div class="text-[11px] space-y-3">
                        <p class="text-slate-400">Asignación de Stakes basada en Kelly calculado:</p>
                        <ul class="space-y-2">
                            <li class="flex items-center gap-2">
                                <span class="badge-stake s1">S1</span> 
                                <span class="text-slate-300">Kelly < <span id="label_k_min">2.0</span>%</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="badge-stake s2">S2</span> 
                                <span class="text-slate-300">Kelly <span id="label_k_min_2">2.0</span>% - <span id="label_k_max">4.0</span>%</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="badge-stake s3">S3</span> 
                                <span class="text-slate-300">Kelly > <span id="label_k_max_2">4.0</span>%</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="scorelab-card p-5 h-64">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        let database = [];
        let marketData = [];
        let profitChart;
        const STATS_SHEET_ID = '1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO';
        const IDS_KEY = 'betags_v5_full_config';
        
        let CONFIG = JSON.parse(localStorage.getItem(IDS_KEY)) || {
            over25: '', under25: '', btts_yes: '', btts_no: '', 
            margin: 5, s1: 1, s2: 2, s3: 3, bank: 1000,
            kellyMin: 2, kellyMax: 4
        };

        document.addEventListener('DOMContentLoaded', () => {
            initInputs();
            syncSheet();
        });

        function initInputs() {
            document.getElementById('id_over25').value = CONFIG.over25 || '';
            document.getElementById('id_under25').value = CONFIG.under25 || '';
            document.getElementById('id_btts_yes').value = CONFIG.btts_yes || '';
            document.getElementById('id_btts_no').value = CONFIG.btts_no || '';
            document.getElementById('value_margin_range').value = CONFIG.margin;
            document.getElementById('s1_val').value = CONFIG.s1;
            document.getElementById('s2_val').value = CONFIG.s2;
            document.getElementById('s3_val').value = CONFIG.s3;
            document.getElementById('initial_bankroll').value = CONFIG.bank;
            document.getElementById('kelly_min_threshold').value = CONFIG.kellyMin;
            document.getElementById('kelly_max_threshold').value = CONFIG.kellyMax;
            updateUI();
        }

        function updateUI() {
            document.getElementById('margin_label').innerText = CONFIG.margin + '%';
            document.getElementById('label_k_min').innerText = CONFIG.kellyMin.toFixed(1);
            document.getElementById('label_k_min_2').innerText = CONFIG.kellyMin.toFixed(1);
            document.getElementById('label_k_max').innerText = CONFIG.kellyMax.toFixed(1);
            document.getElementById('label_k_max_2').innerText = CONFIG.kellyMax.toFixed(1);
        }

        function updateMarginLabel(val) {
            CONFIG.margin = parseInt(val);
            document.getElementById('margin_label').innerText = val + '%';
        }

        function toggleConfig() {
            const p = document.getElementById('config_panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        function saveIDs() {
            CONFIG.over25 = document.getElementById('id_over25').value;
            CONFIG.under25 = document.getElementById('id_under25').value;
            CONFIG.btts_yes = document.getElementById('id_btts_yes').value;
            CONFIG.btts_no = document.getElementById('id_btts_no').value;
            CONFIG.margin = parseInt(document.getElementById('value_margin_range').value);
            CONFIG.s1 = parseFloat(document.getElementById('s1_val').value);
            CONFIG.s2 = parseFloat(document.getElementById('s2_val').value);
            CONFIG.s3 = parseFloat(document.getElementById('s3_val').value);
            CONFIG.bank = parseFloat(document.getElementById('initial_bankroll').value);
            CONFIG.kellyMin = parseFloat(document.getElementById('kelly_min_threshold').value);
            CONFIG.kellyMax = parseFloat(document.getElementById('kelly_max_threshold').value);
            
            localStorage.setItem(IDS_KEY, JSON.stringify(CONFIG));
            updateUI();
            toggleConfig();
            syncSheet();
        }

        async function syncSheet() {
            const marketType = document.getElementById('market_auto_select').value;
            const currentSheetID = CONFIG[marketType];
            if (!currentSheetID) return;
            
            try {
                const statsRes = await fetch(`https://docs.google.com/spreadsheets/d/${STATS_SHEET_ID}/gviz/tq?tqx=out:json`);
                const statsJson = JSON.parse((await statsRes.text()).substr(47).slice(0, -2));
                
                database = statsJson.table.rows.map((row, index) => ({
                    id: index, league: row.c[0]?.v, date: row.c[1]?.f || row.c[1]?.v,
                    home: row.c[2]?.v, away: row.c[3]?.v, gl: parseFloat(row.c[4]?.v || 0), gv: parseFloat(row.c[5]?.v || 0)
                }));

                const marketRes = await fetch(`https://docs.google.com/spreadsheets/d/${currentSheetID}/gviz/tq?tqx=out:json`);
                const marketJson = JSON.parse((await marketRes.text()).substr(47).slice(0, -2));
                marketData = marketJson.table.rows.map(row => ({
                    date: row.c[1]?.f || row.c[1]?.v, home: row.c[2]?.v, away: row.c[3]?.v, odd: parseFloat(row.c[6]?.v || 0)
                }));

                updateLeagueSelect();
            } catch (e) { console.error("Sync Error", e); }
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))].sort();
            document.getElementById('league_select').innerHTML = '<option>-- LIGA --</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function filterTeamsByLeague() {
            const league = document.getElementById('league_select').value;
            const teams = [...new Set(database.filter(r => r.league === league).map(r => r.home))].sort();
            document.getElementById('team_select').innerHTML = '<option>-- EQUIPO --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function getPoissonProb(lambda, x) {
            const factorial = (n) => (n <= 1 ? 1 : n * factorial(n - 1));
            return (Math.exp(-lambda) * Math.pow(lambda, x)) / factorial(x);
        }

        function runBacktest() {
            const league = document.getElementById('league_select').value;
            const team = document.getElementById('team_select').value;
            const position = document.getElementById('position_select').value;
            const marketType = document.getElementById('market_auto_select').value;
            
            if (!team || team.includes('--')) return;

            let allMatches = database.filter(r => r.league === league && (position === 'home' ? r.home === team : r.away === team));
            const tbody = document.getElementById('backtest_body');
            tbody.innerHTML = '';

            let wins = 0, betsPlaced = 0, totalProfitUnits = 0, currentBank = CONFIG.bank, chartData = [];

            for (let i = 10; i < allMatches.length; i++) {
                const target = allMatches[i];
                const last10 = allMatches.slice(i - 10, i);
                const avgG = last10.reduce((acc, m) => acc + (m.gl + m.gv), 0) / 10;
                
                let prob = 0;
                if (marketType.includes('over25')) {
                    prob = (1 - (getPoissonProb(avgG, 0) + getPoissonProb(avgG, 1) + getPoissonProb(avgG, 2))) * 100;
                } else if (marketType.includes('under25')) {
                    prob = (getPoissonProb(avgG, 0) + getPoissonProb(avgG, 1) + getPoissonProb(avgG, 2)) * 100;
                } else {
                    prob = (last10.filter(m => m.gl > 0 && m.gv > 0).length / 10) * 100;
                }

                const odd = (marketData.find(m => m.home === target.home && m.away === target.away) || { odd: 2.0 }).odd;
                const bookieProb = (1 / odd) * 100;
                const hasValue = prob >= (bookieProb + CONFIG.margin);

                let stakeInfo = { label: '-', percent: 0, class: '' };
                let profitCash = 0;
                let kellyPctDisplay = 0;

                if (hasValue) {
                    const p = prob / 100;
                    const b = odd - 1;
                    const kellyRaw = ((p * b) - (1 - p)) / b;
                    kellyPctDisplay = kellyRaw * 100;
                    
                    if (kellyPctDisplay >= CONFIG.kellyMax) { 
                        stakeInfo = { label: 'S3', percent: CONFIG.s3, class: 's3' }; 
                    } else if (kellyPctDisplay >= CONFIG.kellyMin) { 
                        stakeInfo = { label: 'S2', percent: CONFIG.s2, class: 's2' }; 
                    } else { 
                        stakeInfo = { label: 'S1', percent: CONFIG.s1, class: 's1' }; 
                    }

                    const stakeAmount = currentBank * (stakeInfo.percent / 100);
                    const isWin = marketType === 'over25' ? (target.gl + target.gv > 2.5) : 
                                  marketType === 'under25' ? (target.gl + target.gv < 2.5) :
                                  marketType === 'btts_yes' ? (target.gl > 0 && target.gv > 0) : !(target.gl > 0 && target.gv > 0);

                    if (isWin) {
                        profitCash = stakeAmount * (odd - 1);
                        totalProfitUnits += (odd - 1) * (stakeInfo.percent / CONFIG.s1);
                        wins++;
                    } else {
                        profitCash = -stakeAmount;
                        totalProfitUnits -= (stakeInfo.percent / CONFIG.s1);
                    }
                    currentBank += profitCash;
                    betsPlaced++;
                }

                chartData.push(currentBank.toFixed(2));
                tbody.innerHTML += `
                    <tr class="border-b border-white/5 ${hasValue ? 'bg-cyan-500/5' : 'opacity-40'}">
                        <td class="p-3 text-slate-500">${i-9}</td>
                        <td class="p-3 font-bold text-white text-[10px]">${target.home} vs ${target.away}</td>
                        <td class="p-3"><span class="text-cyan-400 font-bold">${prob.toFixed(1)}%</span></td>
                        <td class="p-3 text-slate-500">${hasValue ? kellyPctDisplay.toFixed(1) + '%' : '-'}</td>
                        <td class="p-3"><span class="badge-stake ${stakeInfo.class}">${stakeInfo.label}</span></td>
                        <td class="p-3 font-mono text-cyan-400">${odd.toFixed(2)}</td>
                        <td class="p-3 ${profitCash > 0 ? 'backtest-win' : profitCash < 0 ? 'backtest-loss' : 'backtest-nobet'}">${profitCash > 0 ? 'WIN' : profitCash < 0 ? 'LOSS' : 'NO'}</td>
                        <td class="p-3 font-black ${profitCash >= 0 ? 'profit-positive' : 'profit-negative'}">${profitCash.toFixed(2)}</td>
                    </tr>`;
            }

            document.getElementById('bt_total').innerText = betsPlaced;
            document.getElementById('bt_winrate').innerText = betsPlaced > 0 ? ((wins / betsPlaced) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('bt_profit').innerText = totalProfitUnits.toFixed(2);
            document.getElementById('bt_balance').innerText = currentBank.toLocaleString();
            updateChart(chartData);
        }

        function updateChart(data) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (profitChart) profitChart.destroy();
            profitChart = new Chart(ctx, {
                type: 'line', data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{ label: 'Bankroll', data: data, borderColor: '#00f2ff', backgroundColor: 'rgba(0, 242, 255, 0.1)', fill: true, tension: 0.2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#64748b' } }, x: { display: false } } }
            });
        }

        window.onload = syncSheet;
    </script>
</body>
</html>