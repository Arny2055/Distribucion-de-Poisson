<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Quantum Backtester v5.0 (Corrected)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff;
            --sl-green: #00ff88;
            --sl-red: #ff4d4d;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { background: var(--sl-card); border: 1px solid var(--sl-border); border-radius: 12px; }
        input, select { background-color: #05070a !important; color: white !important; border: 1px solid var(--sl-border) !important; }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
        }

        .backtest-win { color: var(--sl-green); font-weight: bold; }
        .backtest-loss { color: var(--sl-red); font-weight: bold; }
        .backtest-nobet { color: #64748b; font-weight: bold; font-style: italic; }
        
        .profit-positive { color: var(--sl-green); text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .profit-negative { color: var(--sl-red); text-shadow: 0 0 10px rgba(255,77,77,0.3); }

        #config_panel { display: none; position: absolute; top: 70px; right: 20px; z-index: 100; width: 320px; }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v5.0 PRO BACKTESTER</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Mercado</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="under25">UNDER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                        <option value="btts_no">BTTS NO</option>
                    </select>
                </div>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded">
                    <i class="fa-solid fa-gear mr-1"></i> CONFIGURACIÓN
                </button>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3">Ajustes de Estrategia</h3>
        <div class="space-y-3">
            <div class="bg-cyan-500/10 p-2 rounded border border-cyan-500/20 mb-2">
                <label class="text-[8px] text-cyan-400 font-bold uppercase block mb-1">Margen de Valor Requerido (%)</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="value_margin_range" min="0" max="20" value="5" oninput="updateMarginLabel(this.value)" class="flex-1">
                    <span id="margin_label" class="text-xs font-black text-white w-8">5%</span>
                </div>
            </div>
            
            <div class="bg-yellow-500/10 p-2 rounded border border-yellow-500/20 mb-2">
                <label class="text-[8px] text-yellow-500 font-bold uppercase block mb-1">Kelly Fracción / Stake Máx</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="range" id="kelly_fraction_range" min="0.1" max="1" step="0.1" value="0.5" oninput="updateKellyLabel(this.value)" class="flex-1">
                    <span id="kelly_label" class="text-xs font-black text-white w-8">0.5</span>
                </div>
                <div class="flex items-center gap-2">
                    <input type="range" id="max_stake_range" min="1" max="15" step="1" value="5" oninput="updateStakeLabel(this.value)" class="flex-1">
                    <span id="stake_limit_label" class="text-xs font-black text-white w-8">5%</span>
                </div>
            </div>

            <div>
                <label class="text-[8px] text-slate-400 uppercase">Bankroll Inicial</label>
                <input type="number" id="initial_bankroll" class="w-full p-2 text-[10px] rounded" value="1000">
            </div>

            <hr class="border-white/5">
            <div class="space-y-1">
                <input type="text" id="id_over25" class="w-full p-2 text-[10px] rounded" placeholder="ID Over 2.5">
                <input type="text" id="id_under25" class="w-full p-2 text-[10px] rounded" placeholder="ID Under 2.5">
                <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] rounded" placeholder="ID BTTS Yes">
                <input type="text" id="id_btts_no" class="w-full p-2 text-[10px] rounded" placeholder="ID BTTS No">
            </div>
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar y Recalcular</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3 border-cyan-500/30">
                <label class="text-[9px] font-black text-slate-500 uppercase">1. Liga</label>
                <select id="league_select" onchange="runLeagueWideBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">2. Equipo</label>
                <select id="team_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">3. Posición</label>
                <select id="position_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1">
                    <option value="home">COMO LOCAL</option>
                    <option value="away">COMO VISITANTE</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <div class="scorelab-card p-3 border-l-2 border-cyan-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Bets Eq.</p>
                        <h3 id="bt_total" class="text-xl font-black">0</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-green-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Win Rate</p>
                        <h3 id="bt_winrate" class="text-xl font-black">0%</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-yellow-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Profit Un.</p>
                        <h3 id="bt_profit" class="text-xl font-black">0.00</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-purple-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Balance</p>
                        <h3 id="bt_balance" class="text-xl font-black">0.00</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-cyan-400 bg-cyan-500/10 col-span-2 md:col-span-1">
                        <p class="text-[8px] font-bold text-cyan-400 uppercase">PROFIT LIGA</p>
                        <h3 id="league_profit_total" class="text-xl font-black text-cyan-400">0.00</h3>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                                <tr>
                                    <th class="p-3">#</th>
                                    <th class="p-3">Fecha</th>
                                    <th class="p-3">Partido</th>
                                    <th class="p-3">Poisson</th>
                                    <th class="p-3">Stake</th>
                                    <th class="p-3">Cuota</th>
                                    <th class="p-3">Resultado</th>
                                    <th class="p-3">Profit</th>
                                </tr>
                            </thead>
                            <tbody id="backtest_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest">Auditoría de Datos</h2>
                    <div id="team_info" class="text-sm space-y-3">
                        <div class="p-3 bg-black/30 rounded border border-white/5">
                            <div class="flex justify-between mb-1">
                                <span class="text-[10px] text-slate-400 uppercase">Muestra Liga:</span>
                                <span id="league_bets_count" class="text-[10px] text-white font-bold">0 bets</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[10px] text-slate-400 uppercase">Filtro Valor:</span>
                                <span class="text-[10px] text-green-400 font-bold">Prob ≥ 60%</span>
                            </div>
                        </div>
                        <p class="text-[9px] text-slate-500 leading-relaxed italic">
                            * El sistema utiliza un buffer de 10 partidos previos para calcular el Lambda de Poisson. Los primeros 10 partidos de cada equipo se ignoran para evitar volatilidad por muestra pequeña.
                        </p>
                    </div>
                </div>
                <div class="scorelab-card p-5 h-64">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        let database = [];
        let marketData = [];
        let profitChart;
        const STATS_SHEET_ID = '1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO';
        const IDS_KEY = 'betags_ids_v5_final';
        
        let SHEET_IDS = JSON.parse(localStorage.getItem(IDS_KEY)) || {
            over25: '', under25: '', btts_yes: '', btts_no: '', margin: 5, kelly: 0.5, bank: 1000, maxStake: 5
        };

        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(SHEET_IDS).forEach(key => { if(document.getElementById(`id_${key}`)) document.getElementById(`id_${key}`).value = SHEET_IDS[key]; });
            updateMarginLabel(SHEET_IDS.margin);
            updateKellyLabel(SHEET_IDS.kelly);
            updateStakeLabel(SHEET_IDS.maxStake);
            document.getElementById('initial_bankroll').value = SHEET_IDS.bank;
        });

        function updateMarginLabel(v) { document.getElementById('margin_label').innerText = v + '%'; SHEET_IDS.margin = parseInt(v); }
        function updateKellyLabel(v) { document.getElementById('kelly_label').innerText = v; SHEET_IDS.kelly = parseFloat(v); }
        function updateStakeLabel(v) { document.getElementById('stake_limit_label').innerText = v + '%'; SHEET_IDS.maxStake = parseInt(v); }
        function toggleConfig() { const p = document.getElementById('config_panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }

        function saveIDs() {
            SHEET_IDS.over25 = document.getElementById('id_over25').value;
            SHEET_IDS.under25 = document.getElementById('id_under25').value;
            SHEET_IDS.btts_yes = document.getElementById('id_btts_yes').value;
            SHEET_IDS.btts_no = document.getElementById('id_btts_no').value;
            SHEET_IDS.bank = parseFloat(document.getElementById('initial_bankroll').value);
            localStorage.setItem(IDS_KEY, JSON.stringify(SHEET_IDS));
            toggleConfig();
            syncSheet();
        }

        async function syncSheet() {
            const mType = document.getElementById('market_auto_select').value;
            const currentID = SHEET_IDS[mType];
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${STATS_SHEET_ID}/gviz/tq?tqx=out:json`);
                const text = await res.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                // CRÍTICO: Ordenamiento Cronológico para evitar Sesgo de Anticipación
                database = json.table.rows.map(r => ({
                    league: r.c[0]?.v,
                    date: r.c[1]?.f || r.c[1]?.v,
                    timestamp: Date.parse(r.c[1]?.f || r.c[1]?.v),
                    home: r.c[2]?.v,
                    away: r.c[3]?.v,
                    gl: parseFloat(r.c[4]?.v || 0),
                    gv: parseFloat(r.c[5]?.v || 0)
                })).sort((a, b) => a.timestamp - b.timestamp);

                if (currentID) {
                    const mRes = await fetch(`https://docs.google.com/spreadsheets/d/${currentID}/gviz/tq?tqx=out:json`);
                    const mText = await mRes.text();
                    const mJson = JSON.parse(mText.substr(47).slice(0, -2));
                    marketData = mJson.table.rows.map(r => ({
                        home: r.c[2]?.v,
                        away: r.c[3]?.v,
                        odd: parseFloat(r.c[6]?.v || 2.00)
                    }));
                }
                updateLeagueSelect();
            } catch (e) { console.error("Sync Error:", e); }
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))].sort();
            document.getElementById('league_select').innerHTML = '<option>-- SELECCIONAR --</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function getPoisson(l, x) {
            let fact = n => (n <= 1 ? 1 : n * fact(n - 1));
            return (Math.exp(-l) * Math.pow(l, x)) / fact(x);
        }

        // Lógica Poisson Pro para BTTS y O/U
        function calculateProb(matches, mType) {
            if (matches.length < 5) return 0;
            const avgH = matches.reduce((s, m) => s + m.gl, 0) / matches.length;
            const avgV = matches.reduce((s, m) => s + m.gv, 0) / matches.length;
            const totalAvg = avgH + avgV;

            if (mType.includes('over25')) return (1 - (getPoisson(totalAvg, 0) + getPoisson(totalAvg, 1) + getPoisson(totalAvg, 2))) * 100;
            if (mType.includes('under25')) return (getPoisson(totalAvg, 0) + getPoisson(totalAvg, 1) + getPoisson(totalAvg, 2)) * 100;
            
            // BTTS requiere probabilidad de que ambos anoten > 0
            const probH0 = getPoisson(avgH, 0);
            const probV0 = getPoisson(avgV, 0);
            const bttsYes = (1 - probH0) * (1 - probV0) * 100;
            return mType === 'btts_yes' ? bttsYes : (100 - bttsYes);
        }

        function runLeagueWideBacktest() {
            const league = document.getElementById('league_select').value;
            const mType = document.getElementById('market_auto_select').value;
            if (!league || league.includes('--')) return;

            const leagueMatches = database.filter(r => r.league === league);
            let totalProfitUnits = 0;
            let totalBets = 0;

            // Procesamos partido por partido cronológicamente
            leagueMatches.forEach((match, idx) => {
                const history = leagueMatches.slice(0, idx).filter(m => m.home === match.home || m.away === match.home || m.home === match.away || m.away === match.away).slice(-10);
                
                if (history.length >= 8) {
                    const prob = calculateProb(history, mType);
                    const oddInfo = marketData.find(m => m.home === match.home && m.away === match.away) || { odd: 2.00 };
                    const bookieProb = (1 / oddInfo.odd) * 100;

                    if (prob >= (bookieProb + SHEET_IDS.margin) && prob >= 60) {
                        let kelly = (((prob/100) * (oddInfo.odd - 1)) - (1 - prob/100)) / (oddInfo.odd - 1);
                        let stake = Math.min(Math.max(0, kelly * SHEET_IDS.kelly), SHEET_IDS.maxStake / 100);
                        
                        let win = false;
                        const tg = match.gl + match.gv;
                        if (mType === 'over25') win = tg > 2.5;
                        else if (mType === 'under25') win = tg < 2.5;
                        else if (mType === 'btts_yes') win = match.gl > 0 && match.gv > 0;
                        else win = !(match.gl > 0 && match.gv > 0);

                        totalProfitUnits += win ? (stake * 100 * (oddInfo.odd - 1)) : -(stake * 100);
                        totalBets++;
                    }
                }
            });

            document.getElementById('league_profit_total').innerText = (totalProfitUnits / 100).toFixed(2);
            document.getElementById('league_bets_count').innerText = totalBets + " bets";
            
            // Actualizar select de equipos
            const teams = [...new Set(leagueMatches.map(r => r.home))].sort();
            document.getElementById('team_select').innerHTML = '<option>-- SELECCIONAR --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function runBacktest() {
            const league = document.getElementById('league_select').value;
            const team = document.getElementById('team_select').value;
            const pos = document.getElementById('position_select').value;
            const mType = document.getElementById('market_auto_select').value;
            let currentBank = SHEET_IDS.bank;

            if (!team || team.includes('--')) return;

            const teamMatches = database.filter(r => r.league === league && (pos === 'home' ? r.home === team : r.away === team));
            const tbody = document.getElementById('backtest_body');
            tbody.innerHTML = '';

            let wins = 0, bets = 0, pUnits = 0, chartData = [];

            teamMatches.forEach((match, i) => {
                if (i < 10) return; // Buffer inicial
                const history = teamMatches.slice(i - 10, i);
                const prob = calculateProb(history, mType);
                const oddInfo = marketData.find(m => m.home === match.home && m.away === match.away) || { odd: 2.00 };
                const bookieProb = (1 / oddInfo.odd) * 100;
                const hasValue = (prob >= (bookieProb + SHEET_IDS.margin)) && (prob >= 60);

                let profit = 0, stakePct = 0, status = "NO BET", sClass = "backtest-nobet";

                if (hasValue) {
                    let kelly = (((prob/100) * (oddInfo.odd - 1)) - (1 - prob/100)) / (oddInfo.odd - 1);
                    stakePct = Math.min(Math.max(0, kelly * SHEET_IDS.kelly), SHEET_IDS.maxStake / 100);
                    
                    const tg = match.gl + match.gv;
                    let win = false;
                    if (mType === 'over25') win = tg > 2.5;
                    else if (mType === 'under25') win = tg < 2.5;
                    else if (mType === 'btts_yes') win = match.gl > 0 && match.gv > 0;
                    else win = !(match.gl > 0 && match.gv > 0);

                    if (win) {
                        profit = (currentBank * stakePct) * (oddInfo.odd - 1);
                        pUnits += (stakePct * 100) * (oddInfo.odd - 1);
                        wins++; status = "WIN"; sClass = "backtest-win";
                    } else {
                        profit = -(currentBank * stakePct);
                        pUnits -= (stakePct * 100);
                        status = "LOSS"; sClass = "backtest-loss";
                    }
                    currentBank += profit;
                    bets++;
                }

                chartData.push(currentBank.toFixed(2));
                tbody.innerHTML += `
                    <tr class="border-b border-white/5 ${hasValue ? 'bg-cyan-500/5' : 'opacity-30'}">
                        <td class="p-3 text-slate-500">${i}</td>
                        <td class="p-3 text-[10px]">${match.date}</td>
                        <td class="p-3 font-bold">${match.home} vs ${match.away}</td>
                        <td class="p-3 text-cyan-400 font-mono">${prob.toFixed(1)}%</td>
                        <td class="p-3 text-yellow-500">${(stakePct * 100).toFixed(1)}%</td>
                        <td class="p-3 font-mono">${oddInfo.odd.toFixed(2)}</td>
                        <td class="p-3 ${sClass}">${status}</td>
                        <td class="p-3 font-black ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">${profit.toFixed(2)}</td>
                    </tr>`;
            });

            document.getElementById('bt_total').innerText = bets;
            document.getElementById('bt_winrate').innerText = bets > 0 ? ((wins / bets) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('bt_profit').innerText = (pUnits / 100).toFixed(2);
            document.getElementById('bt_balance').innerText = currentBank.toLocaleString();
            updateChart(chartData);
        }

        function updateChart(d) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (profitChart) profitChart.destroy();
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: d.map((_, i) => i + 1),
                    datasets: [{ label: 'Banca', data: d, borderColor: '#00f2ff', tension: 0.1, fill: true, backgroundColor: 'rgba(0, 242, 255, 0.05)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' } } } }
            });
        }

        window.onload = syncSheet;
    </script>
</body>
</html>