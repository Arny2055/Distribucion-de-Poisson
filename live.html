<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Quantum Backtester v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff;
            --sl-green: #00ff88;
            --sl-red: #ff4d4d;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
        }

        input, select { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
        }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
        }

        .backtest-win { color: var(--sl-green); font-weight: bold; }
        .backtest-loss { color: var(--sl-red); font-weight: bold; }
        .backtest-nobet { color: #64748b; font-weight: bold; font-style: italic; }
        
        .profit-positive { color: var(--sl-green); text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .profit-negative { color: var(--sl-red); text-shadow: 0 0 10px rgba(255,77,77,0.3); }

        #config_panel {
            display: none;
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 100;
            width: 320px;
        }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v5.0 BACKTESTER</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Mercado a Validar</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="under25">UNDER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                        <option value="btts_no">BTTS NO</option>
                    </select>
                </div>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded">
                    <i class="fa-solid fa-gear mr-1"></i> CONFIGURACIÓN
                </button>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3">Ajustes de Estrategia e IDs</h3>
        <div class="space-y-3">
            <div class="bg-cyan-500/10 p-2 rounded border border-cyan-500/20 mb-2">
                <label class="text-[8px] text-cyan-400 font-bold uppercase block mb-1">Margen de Valor Requerido (%)</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="value_margin_range" min="0" max="20" value="5" oninput="updateMarginLabel(this.value)" class="flex-1">
                    <span id="margin_label" class="text-xs font-black text-white w-8">5%</span>
                </div>
            </div>
            
            <div class="bg-yellow-500/10 p-2 rounded border border-yellow-500/20 mb-2">
                <label class="text-[8px] text-yellow-500 font-bold uppercase block mb-1">Criterio de Kelly (Fracción)</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="kelly_fraction_range" min="0.1" max="1" step="0.1" value="0.5" oninput="updateKellyLabel(this.value)" class="flex-1">
                    <span id="kelly_label" class="text-xs font-black text-white w-8">0.5</span>
                </div>
                <div class="mt-2 pt-2 border-t border-yellow-500/10">
                    <label class="text-[8px] text-yellow-500 font-bold uppercase block mb-1">Stake Máximo Permitido (%)</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="max_stake_range" min="1" max="20" step="1" value="5" oninput="updateStakeLabel(this.value)" class="flex-1">
                        <span id="stake_limit_label" class="text-xs font-black text-white w-8">5%</span>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-[8px] text-slate-400 uppercase">Bankroll Inicial</label>
                <input type="number" id="initial_bankroll" class="w-full p-2 text-[10px] rounded" value="1000">
            </div>

            <hr class="border-white/5">
            <div>
                <label class="text-[8px] text-slate-400 uppercase">Google Sheet ID - Over 2.5</label>
                <input type="text" id="id_over25" class="w-full p-2 text-[10px] rounded">
            </div>
            <div>
                <label class="text-[8px] text-slate-400 uppercase">Google Sheet ID - Under 2.5</label>
                <input type="text" id="id_under25" class="w-full p-2 text-[10px] rounded">
            </div>
            <div>
                <label class="text-[8px] text-slate-400 uppercase">Google Sheet ID - BTTS Yes</label>
                <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] rounded">
            </div>
            <div>
                <label class="text-[8px] text-slate-400 uppercase">Google Sheet ID - BTTS No</label>
                <input type="text" id="id_btts_no" class="w-full p-2 text-[10px] rounded">
            </div>
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar y Recalcular</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3 border-cyan-500/30">
                <label class="text-[9px] font-black text-slate-500 uppercase">1. Liga (Auto-Backtest Liga)</label>
                <select id="league_select" onchange="runLeagueWideBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">2. Seleccionar Equipo</label>
                <select id="team_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">3. Posición en Backtest</label>
                <select id="position_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1">
                    <option value="home">COMO LOCAL (Análisis Histórico)</option>
                    <option value="away">COMO VISITANTE (Análisis Histórico)</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <div class="scorelab-card p-3 border-l-2 border-cyan-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Bets Equipo</p>
                        <h3 id="bt_total" class="text-xl font-black">0</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-green-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Win Rate Eq.</p>
                        <h3 id="bt_winrate" class="text-xl font-black">0%</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-yellow-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Profit Unidades</p>
                        <h3 id="bt_profit" class="text-xl font-black">0.00</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-purple-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Balance Equipo</p>
                        <h3 id="bt_balance" class="text-xl font-black">0.00</h3>
                    </div>
                    <div class="scorelab-card p-3 border-l-2 border-cyan-400 bg-cyan-500/5">
                        <p class="text-[8px] font-bold text-cyan-400 uppercase">TOTAL LIGA (Profit)</p>
                        <h3 id="league_profit_total" class="text-xl font-black text-cyan-400">0.00</h3>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <div class="p-3 border-b border-white/5 bg-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase tracking-widest text-cyan-400">Detalle Cronológico del Equipo</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                                <tr>
                                    <th class="p-3">#</th>
                                    <th class="p-3">Fecha</th>
                                    <th class="p-3">Partido</th>
                                    <th class="p-3">Poisson vs Casa</th>
                                    <th class="p-3">Stake %</th>
                                    <th class="p-3">Cuota</th>
                                    <th class="p-3">Estado</th>
                                    <th class="p-3">Profit Cash</th>
                                </tr>
                            </thead>
                            <tbody id="backtest_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest">Resumen Analítico</h2>
                    <div id="team_info" class="text-sm space-y-3">
                        <div class="p-3 bg-black/30 rounded border border-white/5">
                            <p class="text-[10px] text-slate-500 uppercase mb-1">Métricas de Liga:</p>
                            <div class="flex justify-between">
                                <span class="text-[10px] text-slate-400">Equipos Analizados:</span>
                                <span id="league_teams_count" class="text-[10px] text-white font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[10px] text-slate-400">Total Bets Liga:</span>
                                <span id="league_bets_count" class="text-[10px] text-white font-bold">0</span>
                            </div>
                        </div>
                        <p class="text-slate-400 italic text-[11px]">El profit de liga suma el resultado de cada partido único analizado bajo el modelo Poisson.</p>
                    </div>
                </div>
                <div class="scorelab-card p-5 h-64">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        let database = [];
        let marketData = [];
        let profitChart;
        const STATS_SHEET_ID = '1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO';
        const IDS_KEY = 'betags_sheet_ids_v2';
        
        let SHEET_IDS = JSON.parse(localStorage.getItem(IDS_KEY)) || {
            over25: '', under25: '', btts_yes: '', btts_no: '', margin: 5, kelly: 0.5, bank: 1000, maxStake: 5
        };

        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(SHEET_IDS).forEach(key => {
                const el = document.getElementById(`id_${key}`);
                if (el) el.value = SHEET_IDS[key];
            });
            updateMarginLabel(SHEET_IDS.margin || 5);
            updateKellyLabel(SHEET_IDS.kelly || 0.5);
            updateStakeLabel(SHEET_IDS.maxStake || 5);
            if(SHEET_IDS.bank) document.getElementById('initial_bankroll').value = SHEET_IDS.bank;
        });

        function updateMarginLabel(val) { document.getElementById('margin_label').innerText = val + '%'; }
        function updateKellyLabel(val) { document.getElementById('kelly_label').innerText = val; }
        function updateStakeLabel(val) { document.getElementById('stake_limit_label').innerText = val + '%'; }
        function toggleConfig() { const p = document.getElementById('config_panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }

        function saveIDs() {
            SHEET_IDS.over25 = document.getElementById('id_over25').value;
            SHEET_IDS.under25 = document.getElementById('id_under25').value;
            SHEET_IDS.btts_yes = document.getElementById('id_btts_yes').value;
            SHEET_IDS.btts_no = document.getElementById('id_btts_no').value;
            SHEET_IDS.margin = parseInt(document.getElementById('value_margin_range').value);
            SHEET_IDS.kelly = parseFloat(document.getElementById('kelly_fraction_range').value);
            SHEET_IDS.maxStake = parseInt(document.getElementById('max_stake_range').value);
            SHEET_IDS.bank = parseFloat(document.getElementById('initial_bankroll').value);
            localStorage.setItem(IDS_KEY, JSON.stringify(SHEET_IDS));
            toggleConfig();
            syncSheet();
        }

        async function syncSheet() {
            const marketType = document.getElementById('market_auto_select').value;
            const currentSheetID = SHEET_IDS[marketType];
            
            // Limpiar datos previos de liga para evitar errores visuales
            document.getElementById('league_profit_total').innerText = "0.00";
            document.getElementById('league_bets_count').innerText = "0";

            try {
                const statsUrl = `https://docs.google.com/spreadsheets/d/${STATS_SHEET_ID}/gviz/tq?tqx=out:json`;
                const statsRes = await fetch(statsUrl);
                const statsText = await statsRes.text();
                const statsJson = JSON.parse(statsText.substr(47).slice(0, -2));
                database = statsJson.table.rows.map((row, index) => ({
                    league: row.c[0]?.v,
                    date: row.c[1]?.f || row.c[1]?.v,
                    home: row.c[2]?.v,
                    away: row.c[3]?.v,
                    gl: parseFloat(row.c[4]?.v || 0),
                    gv: parseFloat(row.c[5]?.v || 0)
                }));
                if (currentSheetID) {
                    const marketUrl = `https://docs.google.com/spreadsheets/d/${currentSheetID}/gviz/tq?tqx=out:json`;
                    const mRes = await fetch(marketUrl);
                    const mText = await mRes.text();
                    const mJson = JSON.parse(mText.substr(47).slice(0, -2));
                    marketData = mJson.table.rows.map(row => ({
                        home: row.c[2]?.v,
                        away: row.c[3]?.v,
                        odd: parseFloat(row.c[6]?.v || 0)
                    }));
                }
                updateLeagueSelect();
            } catch (e) { console.error("Error sync:", e); }
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))].sort();
            const sel = document.getElementById('league_select');
            sel.innerHTML = '<option>-- SELECCIONAR --</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function filterTeamsByLeague() {
            const league = document.getElementById('league_select').value;
            const teams = [...new Set(database.filter(r => r.league === league).map(r => r.home))].sort();
            const sel = document.getElementById('team_select');
            sel.innerHTML = '<option>-- SELECCIONAR EQUIPO --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function getPoissonProb(lambda, x) {
            const factorial = (n) => (n <= 1 ? 1 : n * factorial(n - 1));
            return (Math.exp(-lambda) * Math.pow(lambda, x)) / factorial(x);
        }

        // --- CORRECCIÓN: BACKTESTING DE TODA LA LIGA (SIN DUPLICADOS) ---
        function runLeagueWideBacktest() {
            filterTeamsByLeague(); 
            const league = document.getElementById('league_select').value;
            if (!league || league.includes('--')) return;

            const leagueMatches = database.filter(r => r.league === league);
            const teams = [...new Set(leagueMatches.map(r => r.home))];
            
            const marketType = document.getElementById('market_auto_select').value;
            const userMargin = SHEET_IDS.margin || 5;
            const kellyFraction = SHEET_IDS.kelly || 0.5;
            const maxStakeLimit = (SHEET_IDS.maxStake || 5) / 100;
            
            let totalLeagueProfitUnits = 0;
            let totalLeagueBets = 0;

            // Analizamos cada partido de la liga una sola vez
            leagueMatches.forEach(match => {
                // Obtenemos historial previo de Local y Visitante para el cálculo de Poisson
                const historyHome = database.filter(r => r.league === league && r.home === match.home && r.date < match.date).slice(-10);
                const historyAway = database.filter(r => r.league === league && r.away === match.away && r.date < match.date).slice(-10);

                if (historyHome.length >= 5 && historyAway.length >= 5) {
                    const avgG = (historyHome.reduce((a,b)=>a+(b.gl+b.gv),0)/historyHome.length + historyAway.reduce((a,b)=>a+(b.gl+b.gv),0)/historyAway.length) / 2;
                    
                    let prob = 0;
                    if (marketType.includes('over25')) prob = (1 - (getPoissonProb(avgG, 0) + getPoissonProb(avgG, 1) + getPoissonProb(avgG, 2))) * 100;
                    else if (marketType.includes('under25')) prob = (getPoissonProb(avgG, 0) + getPoissonProb(avgG, 1) + getPoissonProb(avgG, 2)) * 100;
                    else if (marketType === 'btts_yes') {
                        const bHome = historyHome.filter(m => m.gl > 0 && m.gv > 0).length / historyHome.length;
                        const bAway = historyAway.filter(m => m.gl > 0 && m.gv > 0).length / historyAway.length;
                        prob = ((bHome + bAway) / 2) * 100;
                    }

                    const mInfo = marketData.find(m => m.home === match.home && m.away === match.away) || { odd: 2.00 };
                    const bookieProb = (1 / mInfo.odd) * 100;

                    if (prob >= (bookieProb + userMargin) && prob >= 60) {
                        let kelly = (((prob/100) * (mInfo.odd - 1)) - (1 - prob/100)) / (mInfo.odd - 1);
                        let stake = Math.min(Math.max(0, kelly * kellyFraction), maxStakeLimit);
                        
                        let win = false;
                        const tg = match.gl + match.gv;
                        if (marketType === 'over25') win = tg > 2.5;
                        if (marketType === 'under25') win = tg < 2.5;
                        if (marketType === 'btts_yes') win = match.gl > 0 && match.gv > 0;
                        if (marketType === 'btts_no') win = !(match.gl > 0 && match.gv > 0);

                        totalLeagueProfitUnits += win ? (stake * 100 * (mInfo.odd - 1)) : -(stake * 100);
                        totalLeagueBets++;
                    }
                }
            });

            document.getElementById('league_profit_total').innerText = (totalLeagueProfitUnits / 100).toFixed(2);
            document.getElementById('league_teams_count').innerText = teams.length;
            document.getElementById('league_bets_count').innerText = totalLeagueBets;
            
            // Reiniciar vista individual
            document.getElementById('backtest_body').innerHTML = '';
        }

        function runBacktest() {
            const league = document.getElementById('league_select').value;
            const team = document.getElementById('team_select').value;
            const position = document.getElementById('position_select').value;
            const marketType = document.getElementById('market_auto_select').value;
            const userMargin = SHEET_IDS.margin || 5;
            const kellyFraction = SHEET_IDS.kelly || 0.5;
            const maxStakeLimit = (SHEET_IDS.maxStake || 5) / 100;
            let currentBankroll = SHEET_IDS.bank || 1000;

            if (!team || team.includes('--')) return;

            let allMatches = database.filter(r => r.league === league && (position === 'home' ? r.home === team : r.away === team));
            const tbody = document.getElementById('backtest_body');
            tbody.innerHTML = '';

            let wins = 0, betsPlaced = 0, totalProfitUnits = 0, chartData = [], analyzedCount = 0;

            for (let i = 10; i < allMatches.length; i++) {
                const targetMatch = allMatches[i];
                const last10 = allMatches.slice(i - 10, i);
                const avgG = last10.reduce((acc, m) => acc + (m.gl + m.gv), 0) / 10;
                
                let prob = 0;
                if (marketType.includes('over25')) {
                    prob = (1 - (getPoissonProb(avgG, 0) + getPoissonProb(avgG, 1) + getPoissonProb(avgG, 2))) * 100;
                } else if (marketType.includes('under25')) {
                    prob = (getPoissonProb(avgG, 0) + getPoissonProb(avgG, 1) + getPoissonProb(avgG, 2)) * 100;
                } else if (marketType === 'btts_yes') {
                    prob = (last10.filter(m => m.gl > 0 && m.gv > 0).length / 10) * 100;
                } else {
                    prob = (last10.filter(m => !(m.gl > 0 && m.gv > 0)).length / 10) * 100;
                }

                const mInfo = marketData.find(m => m.home === targetMatch.home && m.away === targetMatch.away) || { odd: 2.00 };
                const odd = mInfo.odd;
                const bookieProb = (1 / odd) * 100;
                const hasValue = (prob >= (bookieProb + userMargin)) && (prob >= 60);

                let profitCash = 0, stakePercent = 0, isWin = false, statusText = "NO BET", statusClass = "backtest-nobet";

                if (hasValue) {
                    let p = prob / 100, b = odd - 1, q = 1 - p;
                    let kellyFull = ((p * b) - q) / b;
                    stakePercent = Math.min(Math.max(0, kellyFull * kellyFraction), maxStakeLimit);
                    let stakeAmount = currentBankroll * stakePercent;

                    const totalG = targetMatch.gl + targetMatch.gv;
                    if (marketType === 'over25') isWin = totalG > 2.5;
                    if (marketType === 'under25') isWin = totalG < 2.5;
                    if (marketType === 'btts_yes') isWin = targetMatch.gl > 0 && targetMatch.gv > 0;
                    if (marketType === 'btts_no') isWin = !(targetMatch.gl > 0 && targetMatch.gv > 0);

                    if (isWin) {
                        profitCash = stakeAmount * (odd - 1);
                        totalProfitUnits += (stakePercent * 100) * (odd - 1);
                        wins++;
                    } else {
                        profitCash = -stakeAmount;
                        totalProfitUnits -= (stakePercent * 100);
                    }
                    currentBankroll += profitCash;
                    betsPlaced++;
                    statusText = isWin ? 'WIN' : 'LOSS';
                    statusClass = isWin ? 'backtest-win' : 'backtest-loss';
                }

                analyzedCount++;
                chartData.push(currentBankroll.toFixed(2));

                tbody.innerHTML += `
                    <tr class="border-b border-white/5 ${hasValue ? 'bg-cyan-500/5' : 'opacity-40'} hover:bg-white/5">
                        <td class="p-3 text-slate-500 font-mono">${analyzedCount}</td>
                        <td class="p-3 text-slate-500 text-[10px]">${targetMatch.date}</td>
                        <td class="p-3 font-bold text-white">${targetMatch.home} vs ${targetMatch.away}</td>
                        <td class="p-3"><span class="text-cyan-400 font-bold">${prob.toFixed(1)}%</span></td>
                        <td class="p-3 font-bold text-yellow-500">${hasValue ? (stakePercent * 100).toFixed(1) + '%' : '-'}</td>
                        <td class="p-3 font-mono text-cyan-400">${odd.toFixed(2)}</td>
                        <td class="p-3 ${statusClass}">${statusText}</td>
                        <td class="p-3 font-black ${profitCash > 0 ? 'profit-positive' : profitCash < 0 ? 'profit-negative' : 'text-slate-600'}">
                            ${profitCash > 0 ? '+' : ''}${profitCash.toFixed(2)}
                        </td>
                    </tr>`;
            }

            document.getElementById('bt_total').innerText = betsPlaced;
            document.getElementById('bt_winrate').innerText = betsPlaced > 0 ? ((wins / betsPlaced) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('bt_profit').innerText = (totalProfitUnits / 100).toFixed(2);
            document.getElementById('bt_balance').innerText = currentBankroll.toLocaleString(undefined, {minimumFractionDigits: 2});
            updateChart(chartData);
        }

        function updateChart(data) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (profitChart) profitChart.destroy();
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Balance Banca',
                        data: data,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } }
                }
            });
        }

        window.onload = syncSheet;
    </script>
</body>
</html>