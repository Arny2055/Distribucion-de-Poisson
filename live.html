<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETAGS - Quantum Backtester v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sl-dark: #080a0f;
            --sl-card: #11141d;
            --sl-accent: #00f2ff;
            --sl-green: #00ff88;
            --sl-red: #ff4d4d;
            --sl-border: #1e222d;
            --sl-gold: #ffcc00;
        }
        
        body { 
            background-color: var(--sl-dark); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, var(--sl-dark) 80%);
            min-height: 100vh;
        }

        .scorelab-card { 
            background: var(--sl-card); 
            border: 1px solid var(--sl-border); 
            border-radius: 12px;
        }

        input, select { 
            background-color: #05070a !important; 
            color: white !important; 
            border: 1px solid var(--sl-border) !important; 
        }

        .btn-primary {
            background: linear-gradient(135deg, #00f2ff 0%, #0077ff 100%);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
        }

        .backtest-win { color: var(--sl-green); font-weight: bold; }
        .backtest-loss { color: var(--sl-red); font-weight: bold; }
        
        .profit-positive { color: var(--sl-green); text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .profit-negative { color: var(--sl-red); text-shadow: 0 0 10px rgba(255,77,77,0.3); }

        #config_panel {
            display: none;
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 100;
            width: 300px;
        }

        .badge-sample {
            background: rgba(0, 242, 255, 0.1);
            color: var(--sl-accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            border: 1px solid rgba(0, 242, 255, 0.2);
        }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-8 bg-cyan-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black tracking-tighter uppercase">BETA<span class="text-cyan-400">GS</span> <span class="text-[10px] text-slate-500 font-normal">v5.0 BACKTESTER</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-500 uppercase ml-1">Estrategia Mercado</span>
                    <select id="market_auto_select" onchange="syncSheet()" class="text-[10px] bg-slate-900 border-none rounded px-2 py-1 text-cyan-400 font-bold">
                        <option value="over05ht">OVER 0.5 HT</option>
                        <option value="over25">OVER 2.5 FT</option>
                        <option value="btts_yes">BTTS YES</option>
                    </select>
                </div>
                <button onclick="toggleConfig()" class="text-[10px] font-black bg-slate-800 text-slate-300 border border-white/10 px-3 py-1 rounded">
                    <i class="fa-solid fa-gear mr-1"></i> IDS
                </button>
            </div>
        </div>
    </nav>

    <div id="config_panel" class="scorelab-card p-4 border-cyan-500/50 shadow-2xl">
        <h3 class="text-[10px] font-black text-cyan-400 uppercase mb-3">Configurar Google Sheets</h3>
        <div class="space-y-3">
            <input type="text" id="id_over05ht" class="w-full p-2 text-[10px] rounded" placeholder="ID Over 0.5 HT">
            <input type="text" id="id_over25" class="w-full p-2 text-[10px] rounded" placeholder="ID Over 2.5 FT">
            <input type="text" id="id_btts_yes" class="w-full p-2 text-[10px] rounded" placeholder="ID BTTS YES">
            <button onclick="saveIDs()" class="w-full btn-primary py-2 rounded text-[10px]">Guardar</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">1. Liga</label>
                <select id="league_select" onchange="filterTeamsByLeague()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">2. Seleccionar Equipo</label>
                <select id="team_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1"></select>
            </div>
            <div class="scorelab-card p-3">
                <label class="text-[9px] font-black text-slate-500 uppercase">3. Posición en Backtest</label>
                <select id="position_select" onchange="runBacktest()" class="w-full p-2 rounded text-xs mt-1">
                    <option value="home">COMO LOCAL (Local vs Visitante)</option>
                    <option value="away">COMO VISITANTE (Visitante vs Local)</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="scorelab-card p-4 border-l-2 border-cyan-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Muestra Analizada</p>
                        <h3 id="bt_total" class="text-2xl font-black">0</h3>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-green-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Aciertos (W/L)</p>
                        <h3 id="bt_winrate" class="text-2xl font-black">0%</h3>
                    </div>
                    <div class="scorelab-card p-4 border-l-2 border-yellow-500">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Profit Total (U)</p>
                        <h3 id="bt_profit" class="text-2xl font-black">0.00</h3>
                    </div>
                </div>

                <div class="scorelab-card overflow-hidden">
                    <div class="p-3 border-b border-white/5 bg-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase tracking-widest text-cyan-400">Historial de Backtesting (Cronológico)</span>
                        <span class="text-[9px] text-slate-500 italic">Analizando datos específicos de cada encuentro</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-black/40 text-[9px] uppercase text-slate-500">
                                <tr>
                                    <th class="p-3">#</th>
                                    <th class="p-3">Fecha</th>
                                    <th class="p-3">Partido Analizado (Target)</th>
                                    <th class="p-3">Muestra Goles</th>
                                    <th class="p-3 text-center">Res.</th>
                                    <th class="p-3">Cuota</th>
                                    <th class="p-3">Estado</th>
                                    <th class="p-3">Profit</th>
                                </tr>
                            </thead>
                            <tbody id="backtest_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-4">
                <div class="scorelab-card p-5">
                    <h2 class="text-[10px] font-black text-cyan-500 uppercase mb-4 tracking-widest">Resumen de Muestra</h2>
                    <div id="team_info" class="text-sm space-y-3">
                        <p class="text-slate-400 italic">Selecciona un equipo para ver el desglose de goles en la muestra.</p>
                    </div>
                </div>
                <div class="scorelab-card p-5 h-64">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        let database = [];
        let marketData = [];
        let profitChart;
        const STATS_SHEET_ID = '1DYUN8_Gr80v6bpj3T2k9Ga2Bg1ZwHYtO';
        const IDS_KEY = 'betags_sheet_ids';
        
        let SHEET_IDS = JSON.parse(localStorage.getItem(IDS_KEY)) || {
            over05ht: '', over25: '1BfAXMV6EHLEz3CJ2lAZO6spHJUXQ-mh6', btts_yes: ''
        };

        function toggleConfig() {
            const p = document.getElementById('config_panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        function saveIDs() {
            SHEET_IDS.over05ht = document.getElementById('id_over05ht').value;
            SHEET_IDS.over25 = document.getElementById('id_over25').value;
            SHEET_IDS.btts_yes = document.getElementById('id_btts_yes').value;
            localStorage.setItem(IDS_KEY, JSON.stringify(SHEET_IDS));
            alert("IDs Guardados");
            syncSheet();
        }

        async function syncSheet() {
            const marketType = document.getElementById('market_auto_select').value;
            const currentSheetID = SHEET_IDS[marketType];
            
            try {
                const statsUrl = `https://docs.google.com/spreadsheets/d/${STATS_SHEET_ID}/gviz/tq?tqx=out:json`;
                const statsRes = await fetch(statsUrl);
                const statsText = await statsRes.text();
                const statsJson = JSON.parse(statsText.substr(47).slice(0, -2));
                
                database = statsJson.table.rows.map((row, index) => ({
                    id: index,
                    league: row.c[0]?.v,
                    date: row.c[1]?.f || row.c[1]?.v,
                    home: row.c[2]?.v,
                    away: row.c[3]?.v,
                    gl: parseFloat(row.c[4]?.v || 0),
                    gv: parseFloat(row.c[5]?.v || 0),
                    gl_ht: parseFloat(row.c[6]?.v || 0),
                    gv_ht: parseFloat(row.c[7]?.v || 0)
                }));

                if (currentSheetID) {
                    const marketUrl = `https://docs.google.com/spreadsheets/d/${currentSheetID}/gviz/tq?tqx=out:json`;
                    const mRes = await fetch(marketUrl);
                    const mText = await mRes.text();
                    const mJson = JSON.parse(mText.substr(47).slice(0, -2));
                    marketData = mJson.table.rows.map(row => ({
                        date: row.c[0]?.f || row.c[0]?.v,
                        league: row.c[1]?.v,
                        home: row.c[2]?.v,
                        away: row.c[3]?.v,
                        odd: parseFloat(row.c[4]?.v || 0)
                    }));
                }

                updateLeagueSelect();
            } catch (e) { console.error("Error sync:", e); }
        }

        function updateLeagueSelect() {
            const leagues = [...new Set(database.map(r => r.league))].sort();
            const sel = document.getElementById('league_select');
            sel.innerHTML = '<option>-- SELECCIONAR --</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        function filterTeamsByLeague() {
            const league = document.getElementById('league_select').value;
            const teams = [...new Set(database.filter(r => r.league === league).map(r => r.home))].sort();
            const sel = document.getElementById('team_select');
            sel.innerHTML = '<option>-- SELECCIONAR EQUIPO --</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function runBacktest() {
            const league = document.getElementById('league_select').value;
            const team = document.getElementById('team_select').value;
            const position = document.getElementById('position_select').value;
            const marketType = document.getElementById('market_auto_select').value;

            if (!team || team.includes('--')) return;

            let matches = database.filter(r => 
                r.league === league && (position === 'home' ? r.home === team : r.away === team)
            );

            matches = matches.reverse();

            const tbody = document.getElementById('backtest_body');
            tbody.innerHTML = '';

            let wins = 0;
            let totalProfit = 0;
            let chartData = [];
            let count = 0;
            let totalGoalsScored = 0;
            let totalGoalsAgainst = 0;

            matches.forEach((targetMatch, index) => {
                const marketInfo = marketData.find(m => 
                    m.home === targetMatch.home && m.away === targetMatch.away
                ) || { odd: 1.85 };
                
                const odd = marketInfo.odd;
                let isWin = false;
                
                const totalG = targetMatch.gl + targetMatch.gv;
                const totalHT = targetMatch.gl_ht + targetMatch.gv_ht;
                
                // Track goals for sample summary
                if (position === 'home') {
                    totalGoalsScored += targetMatch.gl;
                    totalGoalsAgainst += targetMatch.gv;
                } else {
                    totalGoalsScored += targetMatch.gv;
                    totalGoalsAgainst += targetMatch.gl;
                }

                if (marketType === 'over25') isWin = totalG > 2.5;
                if (marketType === 'over05ht') isWin = totalHT > 0.5;
                if (marketType === 'btts_yes') isWin = targetMatch.gl > 0 && targetMatch.gv > 0;

                const profit = isWin ? (odd - 1) : -1;
                if (isWin) wins++;
                totalProfit += profit;
                chartData.push(totalProfit.toFixed(2));
                count++;

                tbody.innerHTML += `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                        <td class="p-3 text-slate-500 font-mono">${index + 1}</td>
                        <td class="p-3 text-slate-500 text-[10px]">${targetMatch.date}</td>
                        <td class="p-3 font-bold text-white">
                            ${targetMatch.home} vs ${targetMatch.away}
                        </td>
                        <td class="p-3">
                            <div class="flex flex-col">
                                <span class="badge-sample w-fit mb-1">Total FT: ${totalG}</span>
                                <span class="text-[9px] text-slate-400 font-mono">HT: ${targetMatch.gl_ht}-${targetMatch.gv_ht} | FT: ${targetMatch.gl}-${targetMatch.gv}</span>
                            </div>
                        </td>
                        <td class="p-3 text-center">${isWin ? '✅' : '❌'}</td>
                        <td class="p-3 font-mono text-cyan-400">${odd.toFixed(2)}</td>
                        <td class="p-3 ${isWin ? 'backtest-win' : 'backtest-loss'}">${isWin ? 'GANADO' : 'PERDIDO'}</td>
                        <td class="p-3 font-black ${profit > 0 ? 'profit-positive' : 'profit-negative'}">${profit > 0 ? '+' : ''}${profit.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Update Sample Info Panel
            const avgGoals = count > 0 ? ((totalGoalsScored + totalGoalsAgainst) / count).toFixed(2) : 0;
            document.getElementById('team_info').innerHTML = `
                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                    <span class="text-slate-500 text-[10px] uppercase">Goles Marcados</span>
                    <span class="text-white font-bold font-mono">${totalGoalsScored}</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                    <span class="text-slate-500 text-[10px] uppercase">Goles Recibidos</span>
                    <span class="text-white font-bold font-mono">${totalGoalsAgainst}</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                    <span class="text-slate-500 text-[10px] uppercase">Promedio Goles/Partido</span>
                    <span class="text-cyan-400 font-bold font-mono">${avgGoals}</span>
                </div>
                <div class="bg-cyan-500/5 p-2 rounded border border-cyan-500/10 mt-2">
                    <p class="text-[9px] text-cyan-400 font-black uppercase">Nota de Mercado</p>
                    <p class="text-[10px] text-slate-400 mt-1">Análisis basado en ${count} partidos registrados en ${league}.</p>
                </div>
            `;

            document.getElementById('bt_total').innerText = count;
            document.getElementById('bt_winrate').innerText = count > 0 ? ((wins / count) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('bt_profit').innerText = totalProfit.toFixed(2);
            document.getElementById('bt_profit').className = `text-2xl font-black ${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}`;

            updateChart(chartData);
        }

        function updateChart(data) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (profitChart) profitChart.destroy();
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Profit Acumulado',
                        data: data,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointBackgroundColor: '#00f2ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                        x: { display: false }
                    }
                }
            });
        }

        window.onload = syncSheet;
    </script>
</body>
</html>